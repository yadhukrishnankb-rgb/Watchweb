<!-- views/user/order-detail.ejs -->
<%- include('../partials/user/header') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    .order-detail-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        text-decoration: none;
        margin-bottom: 1.5rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .back-link:hover {
        color: #3b82f6;
        transform: translateX(-4px);
    }
    
    .page-header {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
    }
    
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
    }
    
    .order-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    @media (min-width: 768px) {
        .order-grid {
            grid-template-columns: 2fr 1fr;
        }
    }
    
    .card {
        background: white;
        border-radius: 12px;
        padding: 1.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        transition: all 0.3s;
    }
    
    .card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .card-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .card-icon {
        font-size: 1.5rem;
    }
    
    .order-item {
        display: flex;
        gap: 1.25rem;
        padding: 1.25rem;
        border: 2px solid #f3f4f6;
        border-radius: 12px;
        margin-bottom: 1rem;
        transition: all 0.2s;
    }
    
    .order-item:hover {
        border-color: #3b82f6;
        background: #f9fafb;
        transform: translateX(4px);
    }
    
    .order-item:last-child {
        margin-bottom: 0;
    }
    
    .item-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .item-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .item-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }
    
    .item-price {
        color: #6b7280;
        font-size: 0.95rem;
    }
    
    .item-total {
        font-weight: 700;
        color: #3b82f6;
        font-size: 1.1rem;
        margin-top: 0.25rem;
    }
    
    .address-card {
        padding: 1.5rem;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-radius: 12px;
        border: 2px solid #e5e7eb;
    }
    
    .address-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.75rem;
    }
    
    .address-line {
        color: #4b5563;
        margin-bottom: 0.4rem;
        line-height: 1.6;
    }
    
    .status-card {
        text-align: center;
        padding: 2rem 1.5rem;
        background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
        border: 2px solid #e5e7eb;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 700;
        text-transform: capitalize;
        margin-bottom: 1rem;
    }
    
    .status-pending { 
        background: #fef3c7; 
        color: #92400e;
        border: 2px solid #fbbf24;
    }
    
    .status-processing { 
        background: #dbeafe; 
        color: #1e40af;
        border: 2px solid #3b82f6;
    }
    
    .status-shipped { 
        background: #dcfce7; 
        color: #166534;
        border: 2px solid #22c55e;
    }
    
    .status-delivered { 
        background: #d1fae5; 
        color: #047857;
        border: 2px solid #10b981;
    }
    
    .status-cancelled { 
        background: #fee2e2; 
        color: #991b1b;
        border: 2px solid #ef4444;
    }
    
    .status-date {
        font-size: 0.9rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .info-grid {
        display: grid;
        gap: 1rem;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        color: #6b7280;
        font-weight: 500;
    }
    
    .info-value {
        color: #111827;
        font-weight: 600;
    }
    
    .amount-card {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #bae6fd;
    }
    
    .amount-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        font-size: 0.95rem;
    }
    
    .amount-label {
        color: #0c4a6e;
        font-weight: 500;
    }
    
    .amount-value {
        color: #0c4a6e;
        font-weight: 600;
    }
    
    .amount-divider {
        height: 1px;
        background: #7dd3fc;
        margin: 0.75rem 0;
    }
    
    .amount-total {
        display: flex;
        justify-content: space-between;
        padding: 1rem 0 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: #0c4a6e;
    }
    
    .btn-invoice {
        display: block;
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        text-align: center;
        text-decoration: none;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
    }
    
    .btn-invoice:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4);
    }
    
    .payment-method {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #f3f4f6;
        border-radius: 8px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.75rem;
    }
    
    .payment-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #d1fae5;
        border-radius: 8px;
        font-weight: 600;
        color: #047857;
    }


.action-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s;
    margin-right: 8px;
    margin-top: 8px;
}

.btn-cancel {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
}

.btn-cancel:hover {
    background: #fecaca;
    transform: translateY(-2px);
}

.btn-return {
    background: #fef3c7;
    color: #b45309;
    border: 1px solid #fcd34d;
}

.btn-return:hover {
    background: #fcd34d;
    transform: translateY(-2px);
}

    
    @media (max-width: 768px) {
        .order-detail-container {
            padding: 1rem 0.5rem;
        }
        
        .page-header {
            padding: 1.5rem;
        }
        
        .page-title {
            font-size: 1.5rem;
        }
        
        .order-item {
            flex-direction: column;
        }
        
        .item-image {
            width: 100%;
            height: 200px;
        }
        
        .card {
            padding: 1.25rem;
        }
        
        .card-title {
            font-size: 1.2rem;
        }
    }
</style>

<div class="order-detail-container">
    <% 
        // Top-level normalized order status (simple, robust fallback)
        const rawFromOrder = (order && (order.status || order.orderStatus || order.currentStatus || order.state) || '').toString().trim().toLowerCase();
        // derive from item statuses when appropriate
        const itemStatuses = (order.orderedItems || []).map(i => ((i.status||'').toString().trim().toLowerCase())).filter(Boolean);
        let derivedOrderStatus = rawFromOrder || '';
        if (itemStatuses.length > 0) {
          if (itemStatuses.every(s => s === 'returned')) derivedOrderStatus = 'returned';
          else if (itemStatuses.every(s => s === 'cancelled')) derivedOrderStatus = 'cancelled';
          else if (itemStatuses.every(s => s === 'delivered')) derivedOrderStatus = derivedOrderStatus || 'delivered';
          else if (itemStatuses.some(s => s === 'return request')) derivedOrderStatus = derivedOrderStatus || 'return request';
        }
        const orderRaw = (derivedOrderStatus || rawFromOrder || 'pending').toString().trim();
        const orderStatusClass = (orderRaw || 'pending').toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
        const orderStatusDisplay = orderRaw ? orderRaw.split(/\s+/).map(s => s ? (s.charAt(0).toUpperCase() + s.slice(1).toLowerCase()) : '').filter(Boolean).join(' ') : 'Pending';
    %>
    <a href="/orders" class="back-link">Back to Orders</a>

    <div class="page-header">
        <h1 class="page-title">Order #<%= order.orderId %></h1>
        <p class="page-subtitle">Complete details of your order and delivery information</p>
    </div>

    <div class="order-grid">
        <!-- Order Items -->
        <div>
            <div class="card">
                <h2 class="card-title">Order Items</h2>

                <!-- ONLY THIS PART IS REPLACED — REST OF YOUR CODE IS EXACTLY SAME -->
                <% order.orderedItems.forEach(item => { %>
                                                                <% 
                                                                    // Inline per-item normalization (fall back to orderRaw)
                                                                    const itemRaw = (item && (item.status || item.itemStatus || item.state) || '').toString().trim();
                                                                    const itemStatus = (itemRaw || '').toLowerCase();
                                                                    // Prefer order status when item status is empty or is the generic 'Placed'
                                                                    const rawForDisplay = (itemRaw && itemRaw.toLowerCase() !== 'placed') ? itemRaw : (orderRaw || 'Pending');
                                                                    const displayStatus = rawForDisplay.toString().split(/\s+/).map(s => s ? (s.charAt(0).toUpperCase() + s.slice(1).toLowerCase()) : '').filter(Boolean).join(' ');
                                                                    const canCancel = orderStatusClass === 'pending' && itemStatus !== 'cancelled';
                                                                    const canReturn = itemStatus === 'delivered' || (orderRaw || '').toLowerCase() === 'delivered';
                                                                %>

                    <div class="order-item" data-item-id="<%= item._id %>">
                        <img src="<%= item.productSnapshot.image %>" alt="<%= item.name %>" class="item-image">
                        
                        <div class="item-details">
                            <h3 class="item-name"><%= item.name %></h3>
                            <p class="item-price">
                                Quantity: <%= item.quantity %> × ₹<%= item.price.toLocaleString() %>
                            </p>
                            <p class="item-total">Total: ₹<%= (item.price * item.quantity).toLocaleString() %></p>

                            <!-- Item Status -->
                                <div style="margin-top:8px; font-weight:700; color:#374151;">
                                Status: 
                                <span style="color:#0a5f5f; text-transform:capitalize;">
                                    <%= displayStatus %>
                                </span>
                            </div>

                            <!-- Action Buttons & Status Messages -->
                            <div style="margin-top:12px;">

                                <% if (canCancel) { %>
                                    <button class="action-btn btn-cancel" 
                                            onclick="requestCancelItem('<%= order._id %>','<%= item._id %>', this)">
                                        Request Cancel
                                    </button>
                                <% } %>

                                <% if (canReturn) { %>
                                    <button class="action-btn btn-return" 
                                            onclick="requestReturnItem('<%= order._id %>','<%= item._id %>', this)">
                                        Request Return
                                    </button>
                                <% } %>

                                <% if (itemStatus.includes('cancellation') || itemStatus.includes('cancel request')) { %>
                                    <div style="margin-top:8px; color:#b45309; font-weight:700;">
                                        Cancellation request pending admin approval
                                    </div>
                                <% } %>

                                <% if (itemStatus.includes('return')) { %>
                                    <div style="margin-top:8px; color:#b45309; font-weight:700;">
                                        Return request pending admin approval
                                    </div>
                                <% } %>

                                <% if (itemStatus === 'cancelled') { %>
                                    <div style="margin-top:8px; color:#10b981; font-weight:700;">
                                        Cancellation approved
                                    </div>
                                <% } %>

                                <% if (itemStatus === 'returned') { %>
                                    <div style="margin-top:8px; color:#10b981; font-weight:700;">
                                        Return approved
                                    </div>
                                <% } %>

                            </div>
                        </div>
                    </div>
                <% }) %>
                <!-- END OF REPLACED SECTION -->

            </div>

       <div class="card">
  <h2 class="card-title">Shipping Address</h2>
  <div class="address-card" style="background:#f8fafc; padding:1.5rem; border-radius:12px; border:1px solid #e2e8f0;">
    <% 
            const a = order.address || order.shippingAddress || {};
      const name = a.fullName || a.name || order.user?.name || (user ? ((user.firstName||'').trim() + ' ' + (user.lastName||'').trim()).trim() : '') || 'Customer';
      const phone = a.phone || a.mobile || order.user?.phone || user?.phone || 'Not provided';
      const altPhone = a.altPhone || '';
      const addr = a.street || a.address || a.line1 || a.addressLine1 || '';
      const landmark = a.landmark || a.addressLine2 || '';
      const locality = a.locality || a.area || '';
      const city = a.city || a.town || 'Not Available';
      const state = a.state || a.stateName || 'Not Available';
      const pincode = a.pincode || a.postalCode || a.zip || a.pin || 'PIN Missing';
    %>

    <div style="font-size:0.95rem; line-height:1.9;">
      <p><strong>Name:</strong> <span style="font-weight:600; color:#1f2937;"><%= name %></span></p>
      
      <% if (addr) { %>
        <p><strong>Address:</strong> <span style="color:#374151;"><%= addr %><%= locality ? ', ' + locality : '' %></span></p>
      <% } %>

      <% if (landmark) { %>
        <p><strong>Landmark:</strong> <span style="color:#374151;"><%= landmark %></span></p>
      <% } %>

      <p><strong>City:</strong> <%= city %></p>
      <p><strong>State:</strong> <%= state %></p>
      <p><strong>Pincode:</strong> <strong><%= pincode %></strong></p>
      <p><strong>Mobile:</strong> <span style="color:#059669; font-weight:600;"><%= phone %></span></p>
      
      <% if (altPhone) { %>
        <p><strong>Alt Phone:</strong> <span style="color:#059669;"><%= altPhone %></span></p>
      <% } %>

      <p><strong>Country:</strong> India</p>
    </div>
  </div>
</div>
        </div>

        <!-- Right Column: Status, Payment, Amount, Invoice (100% unchanged) -->
        <div>
            <div class="card status-card">
                <h2 class="card-title">Order Status</h2>
                <% 
                    const statusClass = orderStatusClass;
                    const statusDisplay = orderStatusDisplay;
                %>
                <span class="status-badge status-<%= statusClass %>"><%= statusDisplay %></span>
                <p class="status-date">
                    <%= new Date(order.createdOn).toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                </p>
            </div>

            <div class="card">
                <h2 class="card-title">Payment Details</h2>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="info-label">Payment Method</span>
                        <span class="payment-method">₹ <%= order.paymentMethod %></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Payment Status</span>
                        <span class="payment-status">✓ <%= order.paymentStatus %></span>
                    </div>
                </div>
            </div>

           <div class="card amount-card">
    <h2 class="card-title">Order Summary</h2>
    
    <div class="amount-row">
        <span class="amount-label">Subtotal</span>
        <span class="amount-value">₹<%= order.subtotal.toLocaleString() %></span>
    </div>
    <div class="amount-row">
        <span class="amount-label">Tax</span>
        <span class="amount-value">₹<%= order.tax.toLocaleString() %></span>
    </div>
    <div class="amount-row">
        <span class="amount-label">Shipping</span>
        <span class="amount-value">₹<%= order.shipping.toLocaleString() %></span>
    </div>
    <div class="amount-divider"></div>
    
    <div class="amount-total">
        <span>Original Amount</span>
        <span>₹<%= order.finalAmount.toLocaleString() %></span>
    </div>
    <% 
        // If controller passed cappedRefunded/finalPaid, prefer them (ensures server-side persistence is used).
        let _cappedRefunded = (typeof cappedRefunded !== 'undefined') ? Number(cappedRefunded) : null;
        let _finalPaid = (typeof finalPaid !== 'undefined') ? Number(finalPaid) : null;

        if (_cappedRefunded == null || isNaN(_cappedRefunded)) {
            const subtotal = Number(order.subtotal || 0);
            const totalTax = Number(order.tax || 0);
            const totalDiscount = Number(order.discount || 0);

            const refundedComputed = (() => {
                if (order.refunded != null && !isNaN(Number(order.refunded)) && Number(order.refunded) > 0) return Number(order.refunded);
                return (order.orderedItems || []).reduce((acc, it) => {
                    const st = ((it.status||'').toString().toLowerCase());
                    if (['cancelled','returned'].includes(st)) {
                        if (it.refundAmount != null && !isNaN(Number(it.refundAmount))) return acc + Number(it.refundAmount);
                        const itemSubtotal = Number(it.totalPrice ?? (it.price * it.quantity) ?? 0);
                        const taxShare = subtotal > 0 ? (itemSubtotal / subtotal) * totalTax : 0;
                        const discountShare = subtotal > 0 ? (itemSubtotal / subtotal) * totalDiscount : 0;
                        return acc + (itemSubtotal + taxShare - discountShare);
                    }
                    return acc;
                }, 0);
            })();

            const roundedRefunded = Math.round((refundedComputed + Number.EPSILON) * 100) / 100;
            _cappedRefunded = Math.min(roundedRefunded, Number(order.finalAmount || 0));
            _finalPaid = Math.max(0, Math.round(((order.finalAmount || 0) - _cappedRefunded + Number.EPSILON) * 100) / 100);
        }

        const hasCancelled = (order.orderedItems || []).some(i => ((i.status||'').toString().toLowerCase() === 'cancelled'));
        const hasReturned = (order.orderedItems || []).some(i => ((i.status||'').toString().toLowerCase() === 'returned'));
        const fullCancelled = ((order.status||'').toString().trim().toLowerCase() === 'cancelled');
        const fullReturned = ((order.status||'').toString().trim().toLowerCase() === 'returned');
    %>

    <div style="margin-top:10px">
            <div class="amount-row">
            <span class="amount-label">Refunded Amount</span>
            <span class="amount-value">₹<%= (_cappedRefunded || 0).toLocaleString() %></span>
        </div>
        <div class="amount-row">
            <span class="amount-label">Final Paid Amount</span>
            <span class="amount-value">₹<%= (_finalPaid || 0).toLocaleString() %></span>
        </div>
    </div>

    <% if (fullCancelled || fullReturned) { %>
        <div style="margin-top:12px; padding:12px; background:#d1fae5; border-radius:8px; text-align:center; font-weight:600; color:#047857;">
            Full amount refunded
        </div>
    <% } else if (hasCancelled || hasReturned) { %>
        <div style="margin-top:12px; padding:12px; background:#fef3c7; border-radius:8px; text-align:center; font-weight:600; color:#92400e;">
            Partial refund processed for cancelled/returned items
        </div>
    <% } %>
</div>

            <div class="card">
    <% 
        // Check if ANY item is Delivered OR whole order is Delivered
        const hasDeliveredItem = order.orderedItems.some(item => ['delivered', 'returned'].includes(((item.status||'').toString().toLowerCase())));
        const canDownloadInvoice = ((order.status||'').toString().trim().toLowerCase() === 'delivered') || hasDeliveredItem;
    %>

    <% if (canDownloadInvoice) { %>
        <a href="/orders/<%= order._id %>/invoice" class="btn-invoice">
            Download Invoice
        </a>
    <% } else { %>
        <div class="btn-invoice" style="background:#9ca3af; cursor:not-allowed; opacity:0.7;">
            Invoice Available After Delivery
        </div>
    <% } %>
</div>
        </div>
    </div>
</div>
<script>
// Beautiful Cancel/Return Popups - EXACTLY LIKE YOUR PHOTO!
async function requestCancelItem(orderId, itemId, btn) {
    const { value: reason } = await Swal.fire({
        title: 'Cancel Order',
        html: `
            <p class="text-gray-600 mb-4">Are you sure you want to cancel this item?<br>
            <strong>This action cannot be undone.</strong></p>
            <div class="text-left">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Please tell us why you're cancelling (optional)
                </label>
                <textarea id="cancel-reason" class="swal2-textarea" placeholder="e.g. Changed my mind, ordered by mistake..." rows="3"></textarea>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#9ca3af',
        confirmButtonText: 'Yes, Cancel Order',
        cancelButtonText: 'Keep Order',
        reverseButtons: true,
        customClass: {
            popup: 'rounded-2xl',
            confirmButton: 'px-8 py-3 text-lg font-semibold rounded-lg',
            cancelButton: 'px-8 py-3 text-lg font-semibold rounded-lg'
        },
        buttonsStyling: false,
        preConfirm: () => {
            return document.getElementById('cancel-reason').value || 'No reason provided';
        }
    });

    if (!reason) return; // User clicked cancel

    // Show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

    try {
       const res = await fetch(`/orders/${orderId}/items/${itemId}/cancel`, {
    method: 'POST',
    credentials: 'same-origin',  // <-- ADD THIS
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reason })
});

        const data = await res.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: data.message || 'Cancelled',
                showConfirmButton: false,
                timer: 1800
            }).then(() => location.reload());
        } else {
            throw new Error(data.message || 'Failed to cancel');
        }
    } catch (err) {
        Swal.fire({
            icon: 'error',
            title: 'Failed',
            text: err.message || 'Something went wrong. Try again.',
            confirmButtonColor: '#ef4444'
        });
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Request Cancel';
    }
}

async function requestReturnItem(orderId, itemId, btn) {
    const { value: reason } = await Swal.fire({
        title: 'Return Order',
        html: `
            <p class="text-gray-600 mb-4">Want to return this item?<br>
            <strong>We'll process your refund once received.</strong></p>
            <div class="text-left">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Reason for return <span class="text-red-500">*</span>
                </label>
                <textarea id="return-reason" class="swal2-textarea" placeholder="e.g. Defective product, wrong size, doesn't match description..." rows="3" required></textarea>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#f59e0b',
        cancelButtonColor: '#9ca3af',
        confirmButtonText: 'Yes, Return Item',
        cancelButtonText: 'Keep Item',
        reverseButtons: true,
        customClass: {
            popup: 'rounded-2xl',
            confirmButton: 'px-8 py-3 text-lg font-semibold rounded-lg',
            cancelButton: 'px-8 py-3 text-lg font-semibold rounded-lg'
        },
        buttonsStyling: false,
        preConfirm: () => {
            const text = document.getElementById('return-reason').value.trim();
            if (!text) {
                Swal.showValidationMessage('Please tell us why you want to return');
            }
            return text;
        }
    });

    if (!reason) return;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

    try {
        const res = await fetch(`/orders/${orderId}/items/${itemId}/return`, {
    method: 'POST',
    credentials: 'same-origin',  // <-- ADD THIS
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reason })
});

        const data = await res.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Return Requested!',
                text: 'We’ll send pickup details soon.',
                confirmButtonColor: '#10b981',
                timer: 3000
            }).then(() => location.reload());
        } else {
            throw new Error(data.message);
        }
    } catch (err) {
        Swal.fire({
            icon: 'error',
            title: 'Failed',
            text: err.message || 'Request failed. Try again.',
            confirmButtonColor: '#ef4444'
        });
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Request Return';
    }
}
</script>

<%- include('../partials/user/footer') %>