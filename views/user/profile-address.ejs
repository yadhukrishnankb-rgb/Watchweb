<%- include('../partials/user/header') %>

<style>
  /* Your existing beautiful styles - keep them all */
  * {margin:0;padding:0;box-sizing:border-box;}
  body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#e8f4f3 0%,#d4e9e7 100%);min-height:100vh;padding:20px;}
  .container {max-width:1200px;margin:0 auto;}

  .profile-container {background:linear-gradient(135deg,#1a7b7b 0%,#2d9c9c 100%);border-radius:20px 20px 0 0;padding:30px 40px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.1);}
  .profile-container h2 {color:white;margin:0;font-size:28px;font-weight:600;}

  .nav-tabs {background:white;padding:20px 40px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap;border-bottom:2px solid #e8f4f3;box-shadow:0 2px 10px rgba(0,0,0,.05);}
  .nav-tab {padding:12px 28px;background:transparent;color:#666;text-decoration:none;border-radius:25px;font-weight:600;font-size:15px;transition:all .3s;border:2px solid transparent;cursor:pointer;}
  .nav-tab:hover {background:#e8f4f3;color:#1a7b7b;}
  .nav-tab.active {background:#1a7b7b;color:white;border-color:#1a7b7b;}
  .nav-tab.logout {background:#ff4757;color:white;}
  .nav-tab.logout:hover {background:#ff3838;}

  .content-card {background:white;border-radius:0 0 20px 20px;padding:40px;box-shadow:0 4px 20px rgba(0,0,0,.1);}
  .address-section{margin-bottom:40px;}
  .section-title{font-size:24px;font-weight:600;color:#1a7b7b;margin-bottom:0;}
  .add-address-btn{display:inline-block;padding:10px 24px;background:#1a7b7b;color:white;border-radius:25px;font-weight:600;font-size:14px;transition:all .3s;border:none;cursor:pointer;}
  .add-address-btn:hover{background:#145e5e;transform:translateY(-2px);}
  .address-form{background:linear-gradient(135deg,#e8f4f3 0%,#d4e9e7 100%);padding:30px;border-radius:15px;margin:20px 0;border-left:4px solid #1a7b7b;display:none;animation:slideDown .3s;}
  .address-form.active{display:block;}
  @keyframes slideDown{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
  .form-group{margin-bottom:20px;}
  .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#1a7b7b;font-size:14px;}
  .form-group input{width:100%;padding:12px 16px;border:2px solid #d4e9e7;border-radius:10px;font-size:15px;background:white;transition:all .3s;}
  .form-group input:focus{outline:none;border-color:#1a7b7b;background:#f8fcfc;box-shadow:0 0 0 3px rgba(26,123,123,.1);}
  .form-actions{display:flex;gap:12px;margin-top:25px;}
  .btn-submit{flex:1;background:#1a7b7b;color:white;padding:12px 24px;border:none;border-radius:25px;cursor:pointer;font-weight:600;font-size:15px;transition:all .3s;}
  .btn-submit:hover{background:#145e5e;transform:translateY(-2px);}
  .btn-cancel-form{flex:1;background:#e0e0e0;color:#333;padding:12px 24px;border:none;border-radius:25px;cursor:pointer;font-weight:600;font-size:15px;transition:all .3s;}
  .btn-cancel-form:hover{background:#d0d0d0;}
  .address-item{background:linear-gradient(135deg,#e8f4f3 0%,#d4e9e7 100%);padding:20px 25px;border-radius:12px;margin-bottom:15px;border-left:4px solid #1a7b7b;transition:transform .3s;}
  .address-item:hover{transform:translateX(5px);box-shadow:0 4px 15px rgba(0,0,0,.1);}
  .address-item > div:first-child{color:#333;font-size:15px;line-height:1.6;margin-bottom:12px;}
  .address-actions{display:flex;gap:10px;margin-top:10px;}
  .btn-edit,.btn-delete{padding:8px 20px;font-size:13px;border-radius:20px;font-weight:600;transition:all .3s;border:none;cursor:pointer;}
  .btn-edit{background:#1a7b7b;color:white;}
  .btn-edit:hover{background:#145e5e;transform:translateY(-2px);}
  .btn-delete{background:#ff4757;color:white;}
  .btn-delete:hover{background:#ff3838;transform:translateY(-2px);}
  .no-address{text-align:center;color:#666;font-style:italic;padding:30px;background:linear-gradient(135deg,#e8f4f3 0%,#d4e9e7 100%);border-radius:12px;margin-top:20px;}

  @media (max-width:768px){
    body{padding:10px;}
    .profile-container{padding:20px;}
    .nav-tabs{padding:15px 10px;gap:8px;}
    .nav-tab{padding:10px 20px;font-size:14px;}
    .content-card{padding:30px 20px;}
  }
</style>

<div class="container">
  <div class="profile-container">
    <h2>Address</h2>
  </div>

  <div class="nav-tabs">
    <a href="/profile" class="nav-tab">My Info</a>
    <a href="/profile/address" class="nav-tab active">Address</a>
    <a href="/orders" class="nav-tab">Orders</a>
    <a href="/profile#wallet" class="nav-tab">My Wallet</a>
    <a href="/logout" class="nav-tab logout">Logout</a>
  </div>

  <div class="content-card">
    <div class="address-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:10px;border-bottom:2px solid #e8f4f3;">
        <h3 class="section-title">Address</h3>
        <a href="#" id="add-address-toggle" class="add-address-btn">+ Add New Address</a>
      </div>

      <!-- Success/Error Messages -->
      <% if (success) { %>
        <div style="background:#d4f4dd;color:#1a7b7b;padding:15px;border-radius:10px;margin-bottom:20px;border-left:4px solid #2d9c9c;">
          <%= success %>
        </div>
      <% } %>
      <% if (error) { %>
        <div style="background:#ffe5e5;color:#c62828;padding:15px;border-radius:10px;margin-bottom:20px;border-left:4px solid #e53935;">
          <%= error %>
        </div>
      <% } %>

      <!-- Add/Edit Form -->
      <div id="address-form-container" class="address-form">
        <form id="address-form" action="/profile/address" method="POST">
          <input type="hidden" name="addressId" id="addressId" value="">
          <div class="form-group"><label>Address Line 1</label><input type="text" name="line1" id="line1" required></div>
          <div class="form-group"><label>Landmark (optional)</label><input type="text" name="landmark" id="landmark" placeholder="Near Mall / Opposite Park"></div>
          <div class="form-group"><label>City</label><input type="text" name="city" id="city" required></div>
          <div class="form-group"><label>State</label><input type="text" name="state" id="state" required></div>
          <div class="form-group"><label>ZIP Code</label><input type="text" name="zip" id="zip" required></div>
          <div class="form-group"><label>Country</label><input type="text" name="country" id="country" required></div>
          <div class="form-actions">
            <button type="submit" class="btn-submit">Save Address</button>
            <button type="button" id="cancel-form" class="btn-cancel-form">Cancel</button>
          </div>
        </form>
      </div>

      <!-- Address List -->
      <% if (user.addresses && user.addresses.length) { %>
        <% user.addresses.filter(a => a).forEach((addr, i) => { %>
          <% const _line1 = addr.line1 || ''; const _landmark = addr.landmark || ''; const _city = addr.city || ''; const _state = addr.state || ''; const _zip = addr.zip || ''; const _country = addr.country || ''; %>
          <div class="address-item">
            <div>
              <div style="font-weight:600; margin-bottom:6px;"><%= _line1 %><%= _landmark ? (' â€” ' + _landmark) : '' %></div>
              <div><%= [_city, _state, _zip, _country].filter(Boolean).join(', ') %></div>
            </div>
            <div class="address-actions">
              <button class="btn-edit" onclick="editAddress(<%= i %>, `<%= _line1 %>`, `<%= _landmark %>`, `<%= _city %>`, `<%= _state %>`, `<%= _zip %>`, `<%= _country %>`)">
                Edit
              </button>
              <button class="btn-delete" onclick="deleteAddress(<%= i %>)">
                Delete
              </button>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="no-address">No address added yet.</div>
      <% } %>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js"></script>
<script>
  const form = document.getElementById('address-form');
  const inputs = form.querySelectorAll('input[required]');

  // Add red border on invalid
  inputs.forEach(input => {
    input.addEventListener('invalid', (e) => {
      e.target.style.borderColor = '#e74c3c';
    });
    input.addEventListener('input', (e) => {
      e.target.style.borderColor = '';
    });
  });

  // Custom validation before submit
  form.addEventListener('submit', function(e) {
    let hasError = false;
    const line1 = document.getElementById('line1').value.trim();
    const city = document.getElementById('city').value.trim();
    const state = document.getElementById('state').value.trim();
    const zip = document.getElementById('zip').value.trim();
    const country = document.getElementById('country').value.trim();
    const landmark = document.getElementById('landmark').value.trim();

    // Reset borders
    inputs.forEach(i => i.style.borderColor = '');

    if (line1.length < 5) {
      showError('line1', 'Address must be at least 5 characters');
      hasError = true;
    }
    if (city.length < 2) {
      showError('city', 'City too short');
      hasError = true;
    }
    if (state.length < 2) {
      showError('state', 'State too short');
      hasError = true;
    }
    if (landmark && landmark.length < 3) {
      showError('landmark', 'Landmark too short');
      hasError = true;
    }
    if (country.length < 2) {
      showError('country', 'Country too short');
      hasError = true;
    }
    if (!/^\d{5,6}$/.test(zip)) {
      showError('zip', 'ZIP must be 5 or 6 digits');
      hasError = true;
    }

    if (hasError) {
      e.preventDefault();
    }
  });

  function showError(id, message) {
    const input = document.getElementById(id);
    input.style.borderColor = '#e74c3c';
    input.focus();
    // Optional: show toast
    Swal.fire({
      icon: 'error',
      title: 'Invalid Input',
      text: message,
      toast: true,
      position: 'top-end',
      timer: 3000,
      showConfirmButton: false
    });
  }

  // Keep your existing functions (toggle, edit, delete)
  const formContainer = document.getElementById('address-form-container');
  const toggleBtn = document.getElementById('add-address-toggle');
  const cancelBtn = document.getElementById('cancel-form');
  const addressIdInput = document.getElementById('addressId');

  toggleBtn.addEventListener('click', e => {
    e.preventDefault();
    formContainer.classList.toggle('active');
    if (formContainer.classList.contains('active')) clearForm();
  });

  cancelBtn.addEventListener('click', () => {
    formContainer.classList.remove('active');
    clearForm();
  });

  function clearForm() {
    form.reset();
    addressIdInput.value = '';
    form.action = '/profile/address';
    inputs.forEach(i => i.style.borderColor = '');
  }

  function editAddress(i, l1, lm, c, s, z, co) {
    document.getElementById('line1').value = l1;
    document.getElementById('landmark').value = lm || '';
    document.getElementById('city').value = c;
    document.getElementById('state').value = s;
    document.getElementById('zip').value = z;
    document.getElementById('country').value = co;
    addressIdInput.value = i;
    form.action = `/profile/address/${i}/edit`;
    formContainer.classList.add('active');
    inputs.forEach(i => i.style.borderColor = '');
    window.scrollTo({top: formContainer.offsetTop - 100, behavior: 'smooth'});
  }

  // Your working delete function (keep it)
  async function deleteAddress(index) {
    const result = await Swal.fire({
      title: 'Delete this address?',
      text: "You won't be able to recover it!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#ff4757',
      cancelButtonColor: '#666',
      confirmButtonText: 'Yes, delete it!',
      cancelButtonText: 'Cancel'
    });

    if (!result.isConfirmed) return;

    Swal.fire({ title: 'Deleting...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    try {
      const response = await fetch('/profile/address/' + index + '/delete', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      const data = await response.json();

      if (response.ok && data.success) {
        Swal.fire({ icon: 'success', title: 'Deleted!', text: data.message, timer: 1500, showConfirmButton: false })
          .then(() => location.reload());
      } else {
        throw new Error(data.message || 'Delete failed');
      }
    } catch (err) {
      Swal.fire('Error', err.message || 'Failed to delete', 'error');
    }
  }

  // Flash messages
  <% if (success) { %>
    Swal.fire({ icon: 'success', title: 'Success!', text: '<%= success %>', timer: 2000, showConfirmButton: false });
  <% } %>
  <% if (error) { %>
    Swal.fire({ icon: 'error', title: 'Error', text: '<%= error %>' });
  <% } %>
</script>

<%- include('../partials/user/footer') %>