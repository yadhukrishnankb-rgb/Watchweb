<%- include('../partials/user/header') %>

<style>
    /* --- minimal UI refinements only (no logic changes) --- */
    :root{
        --primary: #5a7f72;
        --accent: #5a7f72;
        --muted: #6b7280;
        --card: #ffffff;
        --glass: rgba(255,255,255,0.9);
        --radius: 1rem;
        --shadow-soft: 0 10px 30px rgba(16,185,129,0.08);
    }

    /* body { background: linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%); color: #111827; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; } */

    .container { max-width:1200px; margin:0 auto; padding:0 1rem; }

    .card { background:var(--card); border-radius:var(--radius); border:1px solid rgba(15,23,42,0.04); box-shadow:var(--shadow-soft); padding:1.5rem; transition:transform .18s ease,box-shadow .18s ease; }
    .card.fade-in { animation:fadeInUp .5s ease both; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 20px 35px rgba(2,6,23,0.06); }

    .page-header { text-align:center; margin-bottom:2.5rem; }
    .page-header h1 { font-size:2.6rem; margin:0; font-weight:800; background:linear-gradient(90deg,var(--primary),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .page-header p { margin-top:.5rem; color:var(--muted); }

    /* address list layout tweaks */
    .address-list { display:flex; flex-direction:column; gap:1rem; }
    .address-card {
        display:flex; gap:1rem; align-items:flex-start;
        padding:1rem; border-radius:.8rem; background:linear-gradient(180deg,#fff,#fbfffb);
        border:1px solid rgba(15,23,42,0.03); position:relative;
    }
    .address-card.selected { border-color: rgba(16,185,129,0.16); box-shadow: 0 8px 30px rgba(16,185,129,0.06); background: linear-gradient(180deg,#f0fdf4,#e6fbef); }
    .address-info { flex:1; min-width:0; }
    .address-title { display:flex; justify-content:space-between; align-items:center; gap:.75rem; }
    .address-title h4 { margin:0; font-weight:700; font-size:1rem; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .address-meta { color:var(--muted); margin-top:.25rem; font-size:.95rem; }

    .radio-wrap { display:flex; align-items:flex-start; gap:.75rem; }
    .address-card input[type="radio"] { width:1.125rem; height:1.125rem; accent-color:var(--primary); margin-top:.35rem; }

    .edit-btn { background:transparent; border:none; color:var(--primary); font-weight:600; cursor:pointer; padding:.35rem .6rem; border-radius:.5rem; }
    .edit-btn:hover { background:#f0fff4; color:var(--accent); }

    /* items */
    .item-row { display:flex; gap:1rem; padding:1rem; border-radius:.75rem; border:1px solid rgba(15,23,42,0.03); align-items:center; background:linear-gradient(180deg,#fff,#fbfbff); }
    .item-img { width:96px; height:96px; object-fit:cover; border-radius:.5rem; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
    .item-main { flex:1; min-width:0; }
    .price-line { display:flex; justify-content:space-between; color:var(--muted); font-size:.95rem; margin-top:.4rem; }
    .price-line strong { color:#0f172a; font-weight:700; }

    .summary-card { border-radius:.9rem; padding:1.25rem; background:linear-gradient(180deg,#fff,#fcfffb); border:1px solid rgba(15,23,42,0.04); }
    .summary-line { display:flex; justify-content:space-between; padding:.55rem 0; color:var(--muted); }

    .place-order-btn { width:100%; padding:.95rem; font-weight:800; border-radius:.8rem; border:none; color:white; background:linear-gradient(90deg,#5a7f72,#5a7f72); cursor:pointer; box-shadow: 0 12px 30px rgba(239,68,68,0.12); }


.place-order-btn { width:100%; padding:.95rem; font-weight:800; border-radius:.8rem; border:none; color:white; background:linear-gradient(90deg,#5a7f72,#5a7f72); cursor:pointer; box-shadow: 0 12px 30px rgba(239,68,68,0.12); }

    /* Payment method buttons */
.payment-methods {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin: 1.5rem 0;
}

.pay-btn {
    background: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
    font-weight: 600;
}

.pay-btn:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.pay-btn.active {
    border-color: var(--primary);
    background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
    box-shadow: 0 0 0 3px rgba(90, 127, 114, 0.15);
}

.pay-icon {
    font-size: 1.5rem;
    color: var(--primary);
}

.payment__methods {
    margin: 1.5rem 0;
}

.checkout__title {
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: #0f172a;
}

.payment__option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    background: #fff;
}

.payment__option:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.payment__option input[type="radio"] {
    accent-color: var(--primary);
    width: 1.25rem;
    height: 1.25rem;
}

.payment__label {
    font-weight: 600;
    color: #0f172a;
    flex: 1;
}

.payment__option.selected {
    border-color: var(--primary);
    background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
    box-shadow: 0 0 0 3px rgba(90, 127, 114, 0.15);
}

    /* responsive */
    @media (max-width:1024px){ .page-header h1{ font-size:2rem } .item-img{ width:82px; height:82px } }
    @media (max-width:640px){ .grid{ display:block } .card{ padding:1rem } .address-card{ flex-direction:column; align-items:stretch } .address-title{align-items:flex-start} }
</style>

<div class="container">
    <div class="page-header">
        <h1>Secure Checkout</h1>
        <p>Complete your order with confidence</p>
    </div>

    <div class="grid" style="display:grid; grid-template-columns: 1fr 340px; gap:1.5rem;">
        <div>
            <!-- Address Card -->
            <div class="card fade-in" aria-labelledby="delivery-address-title">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem;">
                    <div style="display:flex; gap:1rem; align-items:center;">
                        <div class="icon-box" aria-hidden="true"><i class="fas fa-map-marker-alt"></i></div>
                        <div>
                            <h2 id="delivery-address-title" style="margin:0; font-size:1.125rem; font-weight:800;">Delivery Address</h2>
                            <p style="margin:4px 0 0; color:var(--muted);">Choose where to deliver your items</p>
                        </div>
                    </div>
                    <a href="/profile" class="btn-green" title="Add a new address"> <i class="fas fa-plus"></i> Add New </a>
                </div>

                <% if (user.addresses && user.addresses.length > 0) { %>
                    <div class="address-list" role="list" aria-label="Saved addresses">
                        <% user.addresses.forEach((addr, idx) => { %>
                            <label class="address-card <%= defaultAddress && defaultAddress._id.toString() === addr._id.toString() ? 'selected' : '' %>" role="listitem" tabindex="0">
                                <div class="radio-wrap">
                                    <input type="radio" name="selectedAddress" value="<%= addr._id %>" aria-label="Select delivery address" <%= defaultAddress && defaultAddress._id.toString() === addr._id.toString() ? 'checked' : '' %> required>
                                </div>

                                <div class="address-info">
                                    <div class="address-title">
                                        <h4 title="<%= addr.fullName %>"><%= addr.fullName %></h4>
                                        <% if (addr.isDefault) { %>
                                            <span class="default-tag" aria-hidden="true">DEFAULT</span>
                                        <% } %>
                                    </div>

                                    <div class="address-meta" title="<%= addr.street %>">
                                        <div><%= addr.street %></div>
                                        <div style="margin-top:.25rem;"><%= addr.city %>, <%= addr.state %> - <%= addr.pincode %></div>
                                        <div style="margin-top:.5rem; color:var(--muted); font-weight:600;">
                                            <i class="fas fa-phone" style="color:var(--primary); margin-right:.4rem;"></i>
                                            +91 <%= addr.phone %>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" onclick="editAddress('<%= idx %>')" class="edit-btn" aria-label="Edit address">
                                    <i class="fas fa-edit" aria-hidden="true"></i> Edit
                                </button>
                            </label>
                        <% }) %>
                    </div>
                <% } else { %>
                    <div class="empty-state" role="status" aria-live="polite" style="padding-top:1rem;">
                        <i class="fas fa-home" style="font-size:2.4rem; color:#e5e7eb;"></i>
                        <p style="margin-top:.75rem; font-weight:700;">No addresses added</p>
                        <p style="color:var(--muted); margin-top:.25rem;">Add a delivery address to continue</p>
                        <a href="/profile" class="btn-green" style="margin-top:1rem; display:inline-flex;"><i class="fas fa-plus"></i> Add Address Now</a>
                    </div>
                <% } %>
            </div>

            <!-- Items -->
            <div class="card fade-in" style="margin-top:1rem;">
                <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
                    <div class="icon-box"><i class="fas fa-shopping-bag"></i></div>
                    <div>
                        <h2 style="margin:0; font-size:1.125rem; font-weight:800;">Your Items</h2>
                        <p style="margin-top:.25rem; color:var(--muted);"><%= cart.items.length %> items in your cart</p>
                    </div>
                </div>

                <div style="display:flex; flex-direction:column; gap:1rem;">
                    <% cart.items.forEach(item => { %>
                        <div class="item-row" role="group" aria-label="<%= item.productId.productName %>">
                            <div style="position:relative; width:110px; flex-shrink:0;">
                                <img src="<%= (item.productId.productImage && item.productId.productImage.length) ? item.productId.productImage[0] : '/images/default-product.jpg' %>" class="item-img" alt="<%= item.productId.productName %>">
                                <div class="quantity-badge" aria-hidden="true"><%= item.quantity %></div>
                                <% if (item.discount) { %>
                                    <div class="discount-badge" aria-hidden="true"><%= item.discount %>% OFF</div>
                                <% } %>
                            </div>

                            <div class="item-main">
                                <h4 style="margin:0; font-weight:700; color:#0f172a;"><%= item.productId.productName %></h4>
                                <div class="price-line">
                                    <span>Unit Price × Quantity</span>
                                    <span>₹<%= (item.price || item.productId.price || 0).toLocaleString() %> × <%= item.quantity %></span>
                                </div>
                                <div class="price-line">
                                    <span>Item Total</span>
                                    <strong>₹<%= (item.totalPrice || ((item.price || item.productId.price || 0) * item.quantity)).toLocaleString() %></strong>
                                </div>

                                <% if (typeof tax !== 'undefined' && tax > 0 && typeof subtotal !== 'undefined' && subtotal > 0) { %>
                                    <div class="price-line" title="Tax share">
                                        <span>Tax (GST)</span>
                                        <span>₹<%= ((item.totalPrice * tax / subtotal) || 0).toFixed(2) %></span>
                                    </div>
                                <% } %>

                                <% if (typeof discount !== 'undefined' && discount > 0 && typeof subtotal !== 'undefined' && subtotal > 0) { %>
                                    <div class="price-line" title="Discount share" style="color:#b91c1c; font-weight:600;">
                                        <span>Discount</span>
                                        <span>-₹<%= ((item.totalPrice * discount / subtotal) || 0).toFixed(2) %></span>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <!-- Right summary -->
<aside>
    <div class="card summary-card slide-in" style="position:sticky; top:1.25rem;">
        <div style="display:flex; gap:.75rem; align-items:center; margin-bottom:.5rem;">
            <div class="icon-box" style="width:3rem;height:3rem;font-size:1.125rem;">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div>
                <h3 style="margin:0; font-size:1.125rem; font-weight:800;">Order Summary</h3>
                <p style="margin:6px 0 0; color:var(--muted); font-size:.95rem;">Review & pay</p>
            </div>
        </div>

        <div style="margin-top:.5rem;">
            <div class="summary-line"><span>Subtotal</span> <strong>₹<%= subtotal.toLocaleString() %></strong></div>
            <div class="summary-line"><span>Tax (18% GST)</span> <span>₹<%= (typeof tax !== 'undefined' ? tax.toFixed(2) : '0.00') %></span></div>
            <% if (typeof discount !== 'undefined' && discount > 0) { %>
                <div class="summary-line" style="color:#b91c1c; font-weight:700;"><span>Discount</span> <span>-₹<%= discount.toLocaleString() %></span></div>
            <% } %>
            <div class="summary-line"><span>Shipping</span> <span class="<%= shipping === 0 ? 'text-green-600' : '' %>"><%= shipping === 0 ? 'FREE' : '₹' + shipping %></span></div>
        </div>

        <div class="summary-line total" style="margin-top:.75rem; border-top:1px dashed rgba(0,0,0,0.05); padding-top:.85rem;">
            <span style="font-weight:800;">Total Amount</span>
            <span style="font-weight:900; color:var(--primary);">₹<%= total.toLocaleString() %></span>
        </div>

        <!-- Payment Method Selector -->
             <form id="checkoutForm" action="/checkout/order-success" method="POST">
    <input type="hidden" name="addressId" id="selectedAddressId" value="" />

    <div class="payment__methods">
        <h3 class="checkout__title payment__title">Payment Method</h3>

        <label class="payment__option <%= total <= 2000 ? '' : 'disabled' %>" for="l1">
            <input type="radio" name="paymentMethod" id="l1" value="wallet" class="payment__input" />
            <span class="payment__label">
                <i class="fas fa-wallet"></i> Wallet
            </span>
        </label>

        <label class="payment__option <%= total <= 2000 ? '' : 'disabled' %>" for="l2">
            <input type="radio" name="paymentMethod" id="l2" value="cod" class="payment__input" <%= total <= 2000 ? '' : 'disabled' %> />
            <span class="payment__label">
                <i class="fas fa-truck"></i> Cash on Delivery
            </span>
        </label>

        <label class="payment__option" for="l3">
            <input type="radio" name="paymentMethod" id="l3" value="razorpay" class="payment__input" checked />
            <span class="payment__label">
                <i class="fab fa-cc-visa"></i> Razorpay
            </span>
        </label>
    </div>

    <!-- COD Warning -->
    <p id="cod-warning" class="text-red-600 text-xs mt-2 hidden text-center">
        <i class="fas fa-exclamation-triangle"></i> COD not available for orders above ₹2000
    </p>

    <button type="submit" id="placeOrderBtn" class="place-order-btn" style="margin-top:1rem;">
        <i class="fas fa-lock"></i>
        <span id="payText">Pay ₹<%= total.toLocaleString() %></span>
    </button>
</form>

        <!-- COD Warning (if total > ₹2000) -->
        <p id="cod-warning" class="text-red-600 text-xs mt-2 hidden text-center">
            <i class="fas fa-exclamation-triangle"></i> COD not available for orders above ₹2000
        </p>

      

        <div style="margin-top:1rem;" class="security-badge">
            <p style="margin:0; font-weight:700; color:#065f46;"><i class="fas fa-shield-alt"></i> 100% Secure Checkout</p>
            <p style="margin:.35rem 0 0; color:var(--muted); font-size:.9rem;">Original products • Easy returns</p>
            <div style="margin-top:.6rem; display:flex; gap:.6rem; justify-content:center; color:#9ca3af;">
                <i class="fab fa-cc-visa"></i>
                <i class="fab fa-cc-mastercard"></i>
                <i class="fab fa-cc-paypal"></i>
                <i class="fas fa-wallet"></i>
            </div>
        </div>
    </div>
</aside>
    </div>
</div>

<script>
let selectedPayment = 'razorpay';
const COD_MAX = 2000;

// Sync selected address
document.addEventListener('change', function(e) {
    if (e.target.name === 'selectedAddress') {
        document.getElementById('selectedAddressId').value = e.target.value;
    }
});

// Payment selection + COD disable
document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
    radio.addEventListener('change', function() {
        selectedPayment = this.value;
        document.querySelectorAll('.payment__option').forEach(opt => opt.classList.remove('selected'));
        this.closest('.payment__option').classList.add('selected');

        const payText = document.getElementById('payText');
        const codWarning = document.getElementById('cod-warning');

        if (this.value === 'cod') {
            payText.textContent = 'Place Order (COD)';
            if (<%= total %> > COD_MAX) {
                this.disabled = true;
                this.closest('.payment__option').classList.add('disabled');
                codWarning.classList.remove('hidden');
            } else {
                codWarning.classList.add('hidden');
            }
        } else {
            payText.textContent = 'Pay ₹<%= total.toLocaleString() %>';
            codWarning.classList.add('hidden');
        }
    });
});

// Trigger on load
document.querySelector('input[name="paymentMethod"]:checked').dispatchEvent(new Event('change'));



</script>

<%- include('../partials/user/footer') %>
