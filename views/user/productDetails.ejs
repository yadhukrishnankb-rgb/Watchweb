<%- include('../partials/user/header') %>

<!-- Fallback for Tailwind CSS in case it's not included in header.ejs -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Magnify.js (the plugin you already reference) -->
<script src="/js/jquery.magnify.js"></script>
<link rel="stylesheet" href="/css/magnify.css">

<!-- OPTIONAL – medium-zoom fallback (tiny, no jQuery) -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js"></script>

<style>
/* Custom CSS for Product Details UI */
.product-container { max-width: 1280px; margin: 0 auto; padding: 0 1rem; }

/* Breadcrumbs */
.breadcrumbs { background: #f1f5f9; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; font-size: 0.875rem; line-height: 1.25rem; }

/* Product Card */
.product-card { background: #ffffff; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: box-shadow 0.3s ease; }
.product-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

/* Image Gallery */
.image-gallery { padding: 1.5rem; }
.main-image { border-radius: 0.75rem; transition: transform 0.3s ease; }
.main-image:hover { transform: scale(1.02); }
.thumbnail-btn { border-radius: 0.5rem; transition: all 0.2s ease; }
.thumbnail-btn:hover { transform: scale(1.05); border-color: #3b82f6 !important; }

/* Product Info */
.product-info h1 { font-size: 2rem; font-weight: 700; color: #1e293b; line-height: 1.2; }
.ratings { display: flex; align-items: center; gap: 0.5rem; }
.price-section { background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
.discount-tag { background: #dcfce7; color: #15803d; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
.add-to-cart-btn { background: linear-gradient(to right, #2563eb, #1e40af); padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; }
.add-to-cart-btn:hover:not(:disabled) { background: linear-gradient(to right, #1e40af, #2563eb); transform: translateY(-2px); }
.add-to-cart-btn:disabled { background: #9ca3af; cursor: not-allowed; }

/* Reviews */
.reviews-section { margin-top: 3rem; }
.review-card { background: #ffffff; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); transition: transform 0.2s ease; }
.review-card:hover { transform: translateY(-3px); }

/* Related Products */
.related-products { margin-top: 3rem; }
.related-product-card { background: #ffffff; border-radius: 0.5rem; overflow: hidden; transition: all 0.3s ease; }
.related-product-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
.related-product-card img { transition: transform 0.3s ease; }
.related-product-card:hover img { transform: scale(1.03); }

/* NEW: Quantity Selector */
.quantity-selector {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 1rem 0;
}
.quantity-btn {
  width: 2.5rem;
  height: 2.5rem;
  background: #f1f5f9;
  border: 1px solid #cbd5e1;
  border-radius: 0.5rem;
  font-size: 1.25rem;
  font-weight: 600;
  color: #475569;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
}
.quantity-btn:hover:not(:disabled) {
  background: #e2e8f0;
  color: #1e293b;
}
.quantity-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.quantity-input {
  width: 4rem;
  height: 2.5rem;
  text-align: center;
  border: 1px solid #cbd5e1;
  border-radius: 0.5rem;
  font-size: 1rem;
  font-weight: 600;
  color: #1e293b;
}
.quantity-input::-webkit-inner-spin-button,
.quantity-input::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
</style>

<main class="bg-gray-50 py-8">
<div class="product-container">

<!-- Breadcrumbs -->
<nav class="breadcrumbs flex mb-6 text-sm">
<% try { %>
<% breadcrumbs.forEach((crumb, index) => { %>
<% if (index !== 0) { %>
<span class="mx-2 text-gray-500">/</span>
<% } %>
<% if (crumb.url) { %>
<a href="<%= crumb.url %>" class="text-blue-600 hover:text-blue-800"><%= crumb.name %></a>
<% } else { %>
<span class="text-gray-700"><%= crumb.name %></span>
<% } %>
<% }); %>
<% } catch (e) { %>
<p style="color: red;">Error rendering breadcrumbs: <%= e.message %></p>
<% } %>
</nav>

<!-- Product Details -->
<div class="product-card bg-white rounded-xl shadow-sm overflow-hidden">
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 p-6">

<!-- Image Gallery with Zoom -->
<div class="image-gallery space-y-4">
<div class="relative aspect-square">
<img src="<%= product.productImage[0] %>"
id="mainImage"
class="main-image w-full h-full object-contain cursor-zoom-in"
data-magnify-src="<%= product.productImage[0] %>"
alt="<%= product.productName %>">
</div>
<div class="flex gap-2 overflow-x-auto py-2">
<% product.productImage.forEach((img, index) => { %>
<button onclick="changeMainImage('<%= img %>', this)"
class="thumbnail-btn w-20 h-20 rounded-lg overflow-hidden border-2 <%= index === 0 ? 'border-blue-500' : 'border-transparent' %>">
<img src="<%= img %>" class="w-full h-full object-cover" alt="Product thumbnail">
</button>
<% }); %>
</div>
</div>

<!-- Product Info -->
<div class="product-info space-y-6">
<h1 class="text-3xl font-bold text-gray-900"><%= product.productName %></h1>

<!-- Ratings -->
<div class="ratings flex items-center gap-2">
<div class="flex">
<% for(let i = 1; i <= 5; i++) { %>
<svg class="w-5 h-5 <%= i <= Math.round(averageRating) ? 'text-yellow-400' : 'text-gray-300' %>"
fill="currentColor" viewBox="0 0 20 20">
<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
</svg>
<% } %>
</div>
<span class="text-sm text-gray-600"><%= averageRating.toFixed(1) %> (<%= reviews.length %> reviews)</span>
</div>

<!-- Price and Discounts -->
<div class="price-section space-y-2">
<div class="flex items-baseline gap-2">
<span class="text-3xl font-bold text-gray-900">₹<%= product.salesPrice.toLocaleString() %></span>
<% if (product.regularPrice > product.salesPrice) { %>
<span class="text-lg text-gray-500 line-through">₹<%= product.regularPrice.toLocaleString() %></span>
<span class="discount-tag text-sm font-medium"><%= Math.round((product.regularPrice - product.salesPrice) / product.regularPrice * 100) %>% OFF</span>
<% } %>
</div>

<% if (discounts && discounts.length > 0) { %>
<div class="space-y-2">
<h3 class="text-sm font-medium text-gray-900">Available Offers:</h3>
<% discounts.forEach(discount => { %>
<div class="flex items-center gap-2 text-sm">
<span class="px-2 py-1 bg-green-100 text-green-800 rounded"><%= discount.code %></span>
<span class="text-gray-600"><%= discount.description %></span>
</div>
<% }); %>
</div>
<% } %>
</div>

<!-- Stock Status -->
<div class="<%= stockStatus === 'IN_STOCK' ? 'text-green-600' : 'text-red-600' %> font-medium">
<% switch(stockStatus) {
case 'IN_STOCK': %> In Stock (<%= product.quantity %> available) <% break;
case 'LOW_STOCK': %> Only <%= product.quantity %> left in stock! <% break;
case 'SOLD_OUT': %> Sold Out <% break;
case 'OUT_OF_STOCK': %> Out of Stock <% break;
default: %> Currently Unavailable <% } %>
</div>

<!-- QUANTITY SELECTOR -->
<div class="quantity-selector">
  <button type="button" class="quantity-btn" id="decreaseQty" onclick="updateQuantity(-1)">-</button>
  <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="<%= product.quantity %>" readonly>
  <button type="button" class="quantity-btn" id="increaseQty" onclick="updateQuantity(1)">+</button>
</div>

<!-- Add to Cart Button -->
<button onclick="addToCartWithQty('<%= product._id %>')"
class="add-to-cart-btn w-full py-3 px-8 text-white font-medium <%= ['IN_STOCK', 'LOW_STOCK'].includes(stockStatus) ? '' : 'opacity-50 cursor-not-allowed' %>"
<%= ['IN_STOCK', 'LOW_STOCK'].includes(stockStatus) ? '' : 'disabled' %>>
Add to Cart
</button>

<!-- Buy Now → Direct Checkout -->
<form action="/checkout/direct" method="POST" id="buyNowForm">
  <input type="hidden" name="productId" value="<%= product._id %>">
  <input type="hidden" name="quantity" id="buyNowQty" value="1">
  <button type="submit"
    class="add-to-cart-btn w-full py-3 px-8 text-white font-medium bg-green-600 hover:bg-green-700"
    <%= product.quantity <= 0 ? 'disabled' : '' %>>
    Buy Now
  </button>
</form>

<!-- Product Highlights -->
<div class="space-y-4">
<h3 class="text-lg font-medium text-gray-900">Product Highlights</h3>
<ul class="list-disc list-inside space-y-2 text-gray-600">
<li>Brand: <%= product.brand %></li>
<li>Color: <%= product.color %></li>
<li>Category: <%= product.category.name %></li>
</ul>
</div>

<!-- Product Description -->
<div class="space-y-4">
<h3 class="text-lg font-medium text-gray-900">Description</h3>
<p class="text-gray-600"><%= product.description %></p>
</div>
</div>
</div>
</div>

<!-- Reviews Section -->
<div class="reviews-section mt-12">
<h2 class="text-2xl font-bold text-gray-900 mb-6">Customer Reviews</h2>
<% if (reviews.length > 0) { %>
<div class="space-y-6">
<% reviews.forEach(review => { %>
<div class="review-card bg-white rounded-lg shadow-sm p-6">
<div class="flex items-center justify-between mb-4">
<div class="flex items-center gap-2">
<div class="flex">
<% for(let i = 1; i <= 5; i++) { %>
<svg class="w-5 h-5 <%= i <= review.rating ? 'text-yellow-400' : 'text-gray-300' %>"
fill="currentColor" viewBox="0 0 20 20">
<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
</svg>
<% } %>
</div>
<span class="font-medium text-gray-900"><%= review.user.name %></span>
</div>
<span class="text-sm text-gray-500"><%= new Date(review.createdAt).toLocaleDateString() %></span>
</div>
<p class="text-gray-600"><%= review.comment %></p>
</div>
<% }); %>
</div>
<% } else { %>
<p class="text-gray-500">No reviews yet.</p>
<% } %>
</div>

<!-- Related Products -->
<% if (relatedProducts.length > 0) { %>
<div class="related-products mt-12">
<h2 class="text-2xl font-bold text-gray-900 mb-6">Related Products</h2>
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
<% relatedProducts.forEach(relatedProduct => { %>
<div class="related-product-card bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition-shadow">
<a href="/product/<%= relatedProduct._id %>">
<img src="<%= relatedProduct.productImage[0] %>" alt="<%= relatedProduct.productName %>" class="w-full h-48 object-cover">
<div class="p-4">
<h3 class="font-medium text-gray-900 mb-1"><%= relatedProduct.productName %></h3>
<p class="text-gray-600">₹<%= relatedProduct.salesPrice.toLocaleString() %></p>
</div>
</a>
</div>
<% }); %>
</div>
</div>
<% } %>
</div>
</main>

<!-- QUANTITY SCRIPT -->
<script>
// Quantity Handler
function updateQuantity(change) {
  const input = document.getElementById('quantityInput');
  const buyNowInput = document.getElementById('buyNowQty');
  let current = parseInt(input.value) || 1;
  const max = parseInt(input.max) || 1;

  current = Math.max(1, Math.min(max, current + change));
  input.value = current;
  buyNowInput.value = current;
}

// Sync on page load
document.addEventListener('DOMContentLoaded', () => {
  updateQuantity(0); // ensure valid
});
</script>

<script>
/* --------------------------------------------------------------
Unified zoom initializer – Magnify.js → medium-zoom → CSS fallback
-------------------------------------------------------------- */
(function () {
const $mainImg = $('#mainImage');
let zoomInstance = null;

function initMagnify() {
if (typeof $.fn.magnify === 'function') {
try { $mainImg.magnify({ speed: 200 }); console.info('Zoom: Magnify.js active'); return true; }
catch (e) { console.warn('Magnify.js failed →', e); }
}
return false;
}

function initMediumZoom() {
if (typeof mediumZoom === 'function') {
if (zoomInstance && typeof zoomInstance.detach === 'function') { zoomInstance.detach(); }
zoomInstance = mediumZoom('#mainImage', { margin: 30, background: '#fff', scrollOffset: 0 });
console.info('Zoom: medium-zoom active'); return true;
}
return false;
}

function initCssZoom() {
const el = document.getElementById('mainImage');
if (!el) return;
el.style.transition = 'transform .25s ease';
el.addEventListener('mouseenter', () => el.style.transform = 'translateZ(0) scale(1.08)');
el.addEventListener('mouseleave', () => el.style.transform = 'translateZ(0) scale(1)');
console.info('Zoom: CSS hover fallback');
}

window.initProductZoom = function () {
if (zoomInstance) { zoomInstance.detach(); zoomInstance = null; }
if (!initMagnify()) { if (!initMediumZoom()) { initCssZoom(); } }
};

window.changeMainImage = function (src, btn) {
const main = document.getElementById('mainImage');
if (!main) return;
main.src = src; main.dataset.magnifySrc = src;
document.querySelectorAll('.thumbnail-btn').forEach(b => b.classList.remove('border-blue-500', 'border-transparent'));
btn.classList.add('border-blue-500');
setTimeout(window.initProductZoom, 50);
};

$(document).ready(function () { window.initProductZoom(); });
})();
</script>

<!-- Add-to-Cart with Quantity -->
<script>
async function addToCartWithQty(productId) {
  const qty = parseInt(document.getElementById('quantityInput').value) || 1;
  try {
    const res = await fetch('/cart/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId, quantity: qty })
    });
    const data = await res.json();

    if (data.success) {
      Swal.fire({ icon: 'success', title: 'Added to Cart!', toast: true, position: 'top-end', timer: 1500, showConfirmButton: false });
      return;
    }

    if (data.alreadyInCart) {
      Swal.fire({ icon: 'info', title: 'Already in cart', text: data.message || 'This product is already in your cart.', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
      return;
    }

    if (data.redirect) location.href = '/shop';
    else throw new Error(data.message || 'Unknown error');
  } catch (err) {
    Swal.fire({ icon: 'error', title: 'Oops…', text: err.message, toast: true, position: 'top-end', timer: 3000 });
  }
}






</script>

<%- include('../partials/user/footer') %>