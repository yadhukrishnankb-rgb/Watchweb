<%- include('../partials/user/header') %>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --green:      #4a5e4a;
    --green-dk:   #3a4a3a;
    --green-lt:   #5a7a5a;
    --bg:         #f0f4f0;
    --text:       #2a3a2a;
    --muted:      #7a9080;
    --line:       rgba(74,94,74,.12);
    --red:        #e8435a;
    --success:    #2ecc71;
  }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ─── TOP BANNER ─── */
  .profile-banner {
    background: linear-gradient(135deg, #3a4a3a 0%, #4a5e4a 60%, #5a7060 100%);
    padding: 56px 0 40px;
    position: relative;
    overflow: hidden;
  }

  .profile-banner::before {
    content: '';
    position: absolute;
    width: 500px; height: 500px;
    border-radius: 50%;
    background: rgba(255,255,255,.04);
    top: -200px; right: -100px;
    pointer-events: none;
  }

  .profile-banner::after {
    content: '';
    position: absolute;
    width: 250px; height: 250px;
    border-radius: 50%;
    background: rgba(255,255,255,.03);
    bottom: 30px; left: -80px;
    pointer-events: none;
  }

  .banner-inner {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 40px;
    position: relative;
    z-index: 1;
  }

  .banner-title {
    padding: 32px 0;
    text-align: center;
  }

  .banner-title h1 {
    font-size: 32px;
    font-weight: 800;
    color: #fff;
    line-height: 1.1;
  }

  /* ─── PAGE BODY ─── */
  .page-body {
    max-width: 900px;
    margin: -20px auto 0;
    padding: 0 40px 80px;
    position: relative;
    z-index: 2;
  }

  /* Balance Card */
  .balance-card {
    background: linear-gradient(135deg, var(--green) 0%, var(--green-lt) 100%);
    color: #fff;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(74,94,74,.2);
    margin-bottom: 32px;
    position: relative;
    overflow: hidden;
  }

  .balance-card::before {
    content: '₹';
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 140px;
    font-weight: 800;
    opacity: .06;
    pointer-events: none;
  }

  .balance-card h3 {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: .85;
    margin-bottom: 16px;
  }

  .balance-amount {
    font-size: 56px;
    font-weight: 800;
    line-height: 1;
  }

  /* Add Money Card */
  .add-money-card {
    background: #fff;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
  }

  .add-money-form input {
    font-size: 1.2rem;
    padding: 0.8rem;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    width: 100%;
  }

  .add-money-btn {
    font-size: 1.1rem;
    padding: 0.8rem 2rem;
    font-weight: 700;
  }

  /* Transaction Section */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 0 16px;
    border-bottom: 2px solid var(--line);
    margin-bottom: 24px;
  }

  .section-title {
    font-size: 20px;
    font-weight: 800;
    color: var(--green);
  }

  /* Table Styles */
  .table-container {
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,.06);
    border: 1px solid var(--line);
  }

  .table-responsive {
    overflow-x: auto;
  }

  .table {
    width: 100%;
    margin: 0;
    border-collapse: collapse;
  }

  .table thead {
    background: linear-gradient(135deg, #dde8dd, #e8f0e8);
  }

  .table th {
    padding: 16px 20px;
    font-size: 12px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: .7px;
    color: var(--green-dk);
    text-align: left;
    border-bottom: 2px solid var(--line);
  }

  .table td {
    padding: 18px 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    border-bottom: 1px solid var(--line);
    vertical-align: middle;
  }

  .table tbody tr:last-child td {
    border-bottom: none;
  }

  .table tbody tr:hover {
    background: #fafcfa;
  }

  /* Badges & Colors */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 5px 14px;
    border-radius: 40px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .5px;
  }

  .badge-credit { background: #d5f5e3; color: #1a7a45; }
  .badge-debit  { background: #fde8ec; color: var(--red); }

  .text-credit { color: var(--success); font-weight: 700; }
  .text-debit  { color: var(--red); font-weight: 700; }

  /* Link */
  .table a {
    color: var(--green);
    text-decoration: none;
    font-weight: 700;
    transition: color .2s;
  }

  .table a:hover {
    color: var(--green-dk);
    text-decoration: underline;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 40px;
    background: #fff;
    border-radius: 16px;
    border: 1px dashed var(--line);
  }

  .empty-state h4 {
    font-size: 20px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 12px;
  }

  .empty-state p {
    color: var(--muted);
    font-size: 14px;
    font-weight: 600;
  }

  /* Back Button */
  .btn-back {
    display: inline-block;
    padding: 12px 32px;
    background: var(--green);
    color: #fff;
    text-decoration: none;
    border-radius: 40px;
    font-weight: 700;
    font-size: 14px;
    transition: all .2s;
  }

  .btn-back:hover {
    background: var(--green-dk);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(74,94,74,.2);
  }

  /* Responsive */
  @media(max-width: 700px) {
    .page-body { padding: 0 20px 60px; }
    .balance-amount { font-size: 42px; }
    .add-money-form input { font-size: 1rem; }
  }
</style>

<div class="profile-banner">
  <div class="banner-inner">
    <div class="banner-title">
      <h1>My Wallet</h1>
    </div>
  </div>
</div>

<div class="page-body">
  <!-- Balance Card -->
  <div class="balance-card">
    <h3>Available Balance</h3>
    <div class="balance-amount">
      ₹<%= wallet.balance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
    </div>
  </div>

  <!-- Add Money -->
  <div class="add-money-card">
    <h4 class="mb-3">Add Money to Wallet</h4>
    <form id="addMoneyForm">
      <div class="mb-3">
        <input 
          type="number" 
          class="form-control add-money-form" 
          id="amount" 
          name="amount" 
          min="100" 
          step="1"
          placeholder="Enter amount (min ₹100)" 
          required
        >
        <small class="text-muted mt-1 d-block">
          Minimum: ₹100 • Instant credit via Razorpay
        </small>
      </div>
      <button type="submit" class="btn btn-success add-money-btn w-100" id="addMoneyBtn">
        Add Money
      </button>
    </form>
  </div>

  <!-- Transaction History -->
  <div class="section-header">
    <h3 class="section-title">Transaction History</h3>
  </div>

  <% if (wallet.transactions && wallet.transactions.length > 0) { %>
    <div class="table-container">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Reason</th>
              <th>Order ID</th>
            </tr>
          </thead>
          <tbody>
            <% 
              const sortedTx = wallet.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
              sortedTx.forEach(tx => { 
            %>
              <tr>
                <td><%= new Date(tx.date).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></td>
                <td>
                  <span class="badge <%= tx.type === 'credit' ? 'badge-credit' : 'badge-debit' %>">
                    <%= tx.type.toUpperCase() %>
                  </span>
                </td>
                <td class="<%= tx.type === 'credit' ? 'text-credit' : 'text-debit' %>">
                  <%= tx.type === 'credit' ? '+' : '-' %>₹<%= tx.amount.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %>
                </td>
                <td><%= tx.reason %></td>
                <td>
                  <% if (tx.orderId) { %>
                    <a href="/orders/<%= tx.orderId %>">
                      <%= tx.orderId.toString().slice(-8).toUpperCase() %>
                    </a>
                  <% } else { %>
                    -
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  <% } else { %>
    <div class="empty-state">
      <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" width="64" height="64">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m18 0V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v3"/>
      </svg>
      <h4>No transactions yet</h4>
      <p>Your wallet activity will appear here once you make purchases, cancellations, returns, or add money.</p>
    </div>
  <% } %>

  <div class="text-center mt-5">
    <a href="/profile" class="btn-back">Back to Profile</a>
  </div>
</div>

<script>
  document.getElementById('addMoneyForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const amountInput = document.getElementById('amount');
    const amount = Number(amountInput.value.trim());
    const btn = document.getElementById('addMoneyBtn');

    if (isNaN(amount) || amount < 100) {
      Swal.fire({
        icon: 'error',
        title: 'Invalid Amount',
        text: 'Please enter an amount of ₹100 or more',
      });
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    try {
      // 1. Create Razorpay order
      const res = await fetch('/wallet/add-money', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount })
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.message || 'Failed to initiate payment');
      }

      // 2. Open Razorpay checkout
      const options = {
        key: data.razorpay.key,
        amount: data.razorpay.amount,
        currency: data.razorpay.currency,
        name: data.razorpay.name,
        description: data.razorpay.description,
        order_id: data.razorpay.order_id,
        prefill: data.razorpay.prefill,
        handler: async function (response) {
          // 3. Verify payment
          const verifyRes = await fetch('/wallet/verify-add-money', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              razorpay_order_id: response.razorpay_order_id,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_signature: response.razorpay_signature,
              amount: amount
            })
          });

          const verifyData = await verifyRes.json();

          if (verifyData.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: verifyData.message,
              confirmButtonText: 'Great!'
            }).then(() => {
              location.reload(); // Refresh to show updated balance & transactions
            });
          } else {
            Swal.fire('Error', verifyData.message || 'Payment verification failed', 'error');
          }
        },
        modal: {
          ondismiss: function () {
            btn.disabled = false;
            btn.innerHTML = 'Add Money';
          }
        },
        theme: { color: "#5a7f72" }
      };

      const rzp = new Razorpay(options);
      rzp.open();

    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: err.message || 'Something went wrong. Please try again.'
      });
      btn.disabled = false;
      btn.innerHTML = 'Add Money';
    }
  });
</script>

<%- include('../partials/user/footer') %>