<%- include('../partials/user/header') %>

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
background: linear-gradient(135deg, #e8f4f3 0%, #d4e9e7 100%);
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
min-height: 100vh;
padding: 20px;
}

.profile-container {
max-width: 1200px;
margin: 0 auto;
}

.profile-header {
background: linear-gradient(135deg, #1a7b7b 0%, #2d9c9c 100%);
border-radius: 20px 20px 0 0;
padding: 60px 40px 40px;
text-align: center;
position: relative;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.profile-image-wrapper {
width: 120px;
height: 120px;
margin: 0 auto 20px;
position: relative;
cursor: pointer;
}

.profile-image {
width: 120px;
height: 120px;
border-radius: 50%;
background: white;
display: flex;
align-items: center;
justify-content: center;
font-size: 48px;
color: #1a7b7b;
font-weight: 600;
border: 4px solid white;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
transition: all 0.3s ease;
}

.profile-image-img {
width: 120px;
height: 120px;
border-radius: 50%;
border: 4px solid white;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
object-fit: cover;
transition: all 0.3s ease;
}

.profile-image-wrapper:hover .profile-image,
.profile-image-wrapper:hover .profile-image-img {
opacity: 0.8;
transform: scale(1.05);
}

.upload-overlay {
position: absolute;
top: 0;
left: 0;
width: 120px;
height: 120px;
border-radius: 50%;
background: rgba(26, 123, 123, 0.7);
display: flex;
align-items: center;
justify-content: center;
color: white;
opacity: 0;
transition: opacity 0.3s ease;
font-size: 24px;
pointer-events: none;
}

.profile-image-wrapper:hover .upload-overlay {
opacity: 1;
}

#profileImageInput {
display: none;
}

.profile-name {
color: white;
font-size: 32px;
font-weight: 600;
margin-bottom: 10px;
}

.profile-content {
background: white;
border-radius: 0 0 20px 20px;
padding: 40px;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.info-section {
margin-bottom: 40px;
}

.info-cards {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
margin-bottom: 30px;
}

.info-card {
background: linear-gradient(135deg, #e8f4f3 0%, #d4e9e7 100%);
padding: 25px;
border-radius: 15px;
border-left: 4px solid #1a7b7b;
}

.info-label {
font-size: 14px;
color: #1a7b7b;
font-weight: 600;
margin-bottom: 8px;
}

.info-value {
font-size: 16px;
color: #333;
}

.section-title {
font-size: 24px;
font-weight: 600;
color: #1a7b7b;
margin-bottom: 25px;
padding-bottom: 10px;
border-bottom: 2px solid #e8f4f3;
}

.form-group {
margin-bottom: 20px;
}

.form-label {
display: block;
font-size: 14px;
font-weight: 600;
color: #1a7b7b;
margin-bottom: 8px;
}

.form-input {
width: 100%;
padding: 14px 18px;
font-size: 15px;
border: 2px solid #d4e9e7;
border-radius: 10px;
transition: all 0.3s ease;
background: white;
}

.form-input:focus {
outline: none;
border-color: #1a7b7b;
background: #f8fcfc;
box-shadow: 0 0 0 3px rgba(26, 123, 123, 0.1);
}

.form-input::placeholder {
color: #999;
}

.address-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
}

.form-group.full-width {
grid-column: 1 / -1;
}

.button-group {
display: flex;
gap: 15px;
margin-top: 30px;
}

.btn {
flex: 1;
padding: 16px 32px;
font-size: 16px;
font-weight: 600;
color: white;
background: linear-gradient(135deg, #1a7b7b 0%, #2d9c9c 100%);
border: none;
border-radius: 50px;
cursor: pointer;
transition: all 0.3s ease;
box-shadow: 0 4px 15px rgba(26, 123, 123, 0.3);
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(26, 123, 123, 0.4);
}

.btn:active {
transform: translateY(0);
}

.message {
padding: 15px 20px;
border-radius: 10px;
margin-top: 20px;
font-size: 14px;
text-align: center;
background: linear-gradient(135deg, #d4f4dd 0%, #c8f0d4 100%);
color: #1a7b7b;
border-left: 4px solid #2d9c9c;
font-weight: 500;
}

@media (max-width: 768px) {
.info-cards {
grid-template-columns: 1fr;
}

.address-grid {
grid-template-columns: 1fr;
}

.button-group {
flex-direction: column;
}

.profile-header {
padding: 40px 20px 30px;
}

.profile-content {
padding: 30px 20px;
}

.profile-name {
font-size: 24px;
}
}
</style>

<div class="profile-container">
<div class="profile-header">
<div class="profile-image-wrapper" id="profileWrapper">
  <% if (user.profileImage) { %>
    <img src="<%= user.profileImage %>" class="profile-image-img" id="profileImg" alt="Profile Image">
  <% } else { %>
    <div class="profile-image" id="profileImg">
      <%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %>
    </div>
  <% } %>
  <div class="upload-overlay">ðŸ“·</div>
</div>
<input type="file" id="profileImageInput" accept="image/*" style="display:none" />

<h1 class="profile-name"><%= user.name %></h1>
</div>

<div class="profile-content">
<form action="/profile/edit" method="POST">
<div class="info-section">
<h2 class="section-title">Personal Information</h2>

<div class="form-group">
<label class="form-label">Full Name</label>
<input type="text" name="name" class="form-input" value="<%= user.name %>" required>
</div>

<div class="info-cards">
<div class="form-group">
<label class="form-label">Email</label>
<input type="email" name="email" class="form-input" value="<%= user.email %>" required>
</div>

<div class="form-group">
<label class="form-label">Phone</label>
<input type="text" name="phone" class="form-input" value="<%= user.phone %>" required>
</div>
</div>
</div>

<div class="info-section">
<h2 class="section-title">Address</h2>

<div class="form-group full-width">
<label class="form-label">Address Line 1</label>
<input type="text" name="line1" class="form-input" value="<%= (user.addresses && user.addresses[0]) ? user.addresses[0].line1 : '' %>" placeholder="Address Line 1">
</div>

<div class="address-grid">
<div class="form-group">
<label class="form-label">City</label>
<input type="text" name="city" class="form-input" value="<%= (user.addresses && user.addresses[0]) ? user.addresses[0].city : '' %>" placeholder="City">
</div>

<div class="form-group">
<label class="form-label">State</label>
<input type="text" name="state" class="form-input" value="<%= (user.addresses && user.addresses[0]) ? user.addresses[0].state : '' %>" placeholder="State">
</div>

<div class="form-group">
<label class="form-label">ZIP Code</label>
<input type="text" name="zip" class="form-input" value="<%= (user.addresses && user.addresses[0]) ? user.addresses[0].zip : '' %>" placeholder="ZIP">
</div>

<div class="form-group">
<label class="form-label">Country</label>
<input type="text" name="country" class="form-input" value="<%= (user.addresses && user.addresses[0]) ? user.addresses[0].country : '' %>" placeholder="Country">
</div>
</div>
</div>

<div class="button-group">
<button type="submit" class="btn">Update Profile</button>
</div>

<% if (message) { %>
<div class="message"><%= message %></div>
<% } %>
</form>
</div>
</div>

<!-- <script>
  const wrapper = document.getElementById('profileWrapper');
  const input = document.getElementById('profileImageInput');

  wrapper.addEventListener('click', () => input.click());

  input.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return alert('No file selected');
    if (!file.type.startsWith('image/')) return alert('Please select an image');

    const fd = new FormData();
    fd.append('profileImage', file);

    try {
      const res = await fetch('/profile/upload-picture', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Upload failed');
      
      // Update UI with round image
      if (document.getElementById('profileImg').tagName === 'DIV') {
        const img = document.createElement('img');
        img.src = data.profileImage;
        img.className = 'profile-image-img';
        img.id = 'profileImg';
        img.alt = 'Profile Image';
        document.getElementById('profileImg').replaceWith(img);
      } else {
        document.getElementById('profileImg').src = data.profileImage;
      }
      alert('Profile picture updated successfully!');
    } catch (err) {
      console.error(err);
      alert('Upload error: ' + err.message);
    } finally {
      input.value = '';
    }
  });
</script> -->


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const form = document.querySelector('form');
  const inputs = form.querySelectorAll('input');

  // Real-time validation
  inputs.forEach(input => {
    input.addEventListener('input', () => {
      validateField(input);
    });
  });

  function validateField(input) {
    const value = input.value.trim();
    let valid = true;
    let message = '';

    switch (input.name) {
      case 'name':
        if (value.length < 2) {
          valid = false;
          message = 'Name must be at least 2 characters';
        }
        break;
      case 'email':
        if (!/^\S+@\S+\.\S+$/.test(value)) {
          valid = false;
          message = 'Enter a valid email';
        }
        break;
      case 'phone':
        if (!/^\d{10}$/.test(value)) {
          valid = false;
          message = 'Phone must be 10 digits';
        }
        break;
      case 'line1':
        if (value && value.length < 5) {
          valid = false;
          message = 'Address must be at least 5 characters';
        }
        break;
      case 'zip':
        if (value && !/^\d{5,6}$/.test(value)) {
          valid = false;
          message = 'ZIP must be 5 or 6 digits';
        }
        break;
    }

    input.style.borderColor = valid ? '#d4e9e7' : '#e74c3c';
    if (!valid && message) {
      showToast(message);
    }
  }

  function showToast(msg) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'error',
      title: msg,
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
  }

  form.addEventListener('submit', (e) => {
    let hasError = false;
    inputs.forEach(input => {
      if (!validateField(input)) hasError = true;
    });

    if (hasError) {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Invalid Input',
        text: 'Please fix the errors above',
        confirmButtonColor: '#1a7b7b'
      });
    }
  });

  // Profile Picture Upload (already good â€“ just improved error handling)
  const wrapper = document.getElementById('profileWrapper');
  const input = document.getElementById('profileImageInput');

  wrapper.addEventListener('click', () => input.click());

  input.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      return Swal.fire('Error', 'Please select an image file', 'error');
    }
    if (file.size > 5 * 1024 * 1024) {
      return Swal.fire('Error', 'Image must be under 5MB', 'error');
    }

    const fd = new FormData();
    fd.append('profileImage', file);

    try {
      const res = await fetch('/profile/upload-picture', { method: 'POST', body: fd });
      const data = await res.json();

      if (res.ok) {
        const img = document.getElementById('profileImg');
        if (img.tagName === 'DIV') {
          const newImg = document.createElement('img');
          newImg.src = data.profileImage + '?t=' + Date.now();
          newImg.className = 'profile-image-img';
          newImg.id = 'profileImg';
          newImg.alt = 'Profile';
          img.replaceWith(newImg);
        } else {
          img.src = data.profileImage + '?t=' + Date.now();
        }
        Swal.fire({ icon: 'success', title: 'Updated!', text: 'Profile picture changed', timer: 1500, showConfirmButton: false });
      } else {
        throw new Error(data.message || 'Upload failed');
      }
    } catch (err) {
      Swal.fire('Upload Failed', err.message, 'error');
    }
  });
</script>

<%- include('../partials/user/footer') %>