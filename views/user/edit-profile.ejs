<%- include('../partials/user/header') %>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --green:      #4a5e4a;
  --green-dk:   #3a4a3a;
  --green-lt:   #5a7a5a;
  --bg:         #f0f4f0;
  --text:       #2a3a2a;
  --muted:      #7a9080;
  --line:       rgba(74,94,74,.12);
  --red:        #e8435a;
  --success:    #2ecc71;
}

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* â”€â”€â”€ TOP BANNER â”€â”€â”€ */
.profile-banner {
  background: linear-gradient(135deg, #3a4a3a 0%, #4a5e4a 60%, #5a7060 100%);
  padding: 56px 0 40px;
  position: relative;
  overflow: hidden;
}
.profile-banner::before {
  content: '';
  position: absolute;
  width: 500px; height: 500px;
  border-radius: 50%;
  background: rgba(255,255,255,.04);
  top: -200px; right: -100px;
  pointer-events: none;
}
.profile-banner::after {
  content: '';
  position: absolute;
  width: 250px; height: 250px;
  border-radius: 50%;
  background: rgba(255,255,255,.03);
  bottom: 30px; left: -80px;
  pointer-events: none;
}

.banner-inner {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 40px;
  position: relative;
  z-index: 1;
  text-align: center;
}

/* Profile Image */
.profile-image-wrapper {
  width: 120px;
  height: 120px;
  margin: 0 auto 20px;
  position: relative;
  cursor: pointer;
}

.profile-image {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  color: var(--green);
  font-weight: 700;
  border: 4px solid rgba(255,255,255,.4);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

.profile-image-img {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,.4);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  object-fit: cover;
  transition: all 0.3s ease;
}

.profile-image-wrapper:hover .profile-image,
.profile-image-wrapper:hover .profile-image-img {
  opacity: 0.85;
  transform: scale(1.05);
}

.upload-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(74, 94, 74, 0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  opacity: 0;
  transition: opacity 0.3s ease;
  font-size: 28px;
  pointer-events: none;
}

.profile-image-wrapper:hover .upload-overlay {
  opacity: 1;
}

#profileImageInput {
  display: none;
}

.profile-name {
  color: #fff;
  font-size: 32px;
  font-weight: 800;
  margin-bottom: 10px;
  letter-spacing: -.3px;
}

/* â”€â”€â”€ PAGE BODY â”€â”€â”€ */
.page-body {
  max-width: 1100px;
  margin: -20px auto 0;
  padding: 0 40px 80px;
  position: relative;
  z-index: 2;
}

.content-card {
  background: #fff;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 4px 20px rgba(0,0,0,.08);
}

/* Section */
.info-section {
  margin-bottom: 32px;
}

.section-title {
  font-size: 20px;
  font-weight: 800;
  color: var(--green);
  margin-bottom: 24px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--line);
}

/* Form */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  color: var(--green-dk);
  text-transform: uppercase;
  letter-spacing: .5px;
  margin-bottom: 8px;
}

.form-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #c8d8c8;
  border-radius: 10px;
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  background: #fff;
  transition: border-color .2s, box-shadow .2s;
}

.form-input:focus {
  outline: none;
  border-color: var(--green);
  box-shadow: 0 0 0 3px rgba(74,94,74,.1);
}

.form-input::placeholder {
  color: #aaa;
  font-weight: 500;
}

.form-input.error {
  border-color: var(--red);
}

.info-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 0;
}

.address-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

/* Buttons */
.button-group {
  display: flex;
  gap: 12px;
  margin-top: 32px;
}

.btn {
  flex: 1;
  padding: 14px 32px;
  font-size: 15px;
  font-weight: 700;
  font-family: 'Nunito', sans-serif;
  color: white;
  background: var(--green);
  border: none;
  border-radius: 40px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(74,94,74,.2);
}

.btn:hover {
  background: var(--green-dk);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(74,94,74,.3);
}

.btn:active {
  transform: translateY(0);
}

/* Flash Message */
.message {
  padding: 14px 20px;
  border-radius: 12px;
  margin-top: 20px;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
  background: #d5f5e3;
  color: #1a7a45;
  border-left: 4px solid var(--success);
}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width: 700px) {
  .banner-inner { padding: 0 20px; }
  .page-body { padding: 0 20px 60px; }
  .content-card { padding: 28px 20px; }
  .profile-name { font-size: 24px; }
  .info-cards { grid-template-columns: 1fr; }
  .address-grid { grid-template-columns: 1fr; }
  .button-group { flex-direction: column; }
}
</style>

<div class="profile-banner">
  <div class="banner-inner">
    <div class="profile-image-wrapper" id="profileWrapper">
      <% if (user.profileImage) { %>
        <img src="<%= user.profileImage %>" class="profile-image-img" id="profileImg" alt="Profile Image">
      <% } else { %>
        <div class="profile-image" id="profileImg">
          <%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %>
        </div>
      <% } %>
      <div class="upload-overlay">ðŸ“·</div>
    </div>
    <input type="file" id="profileImageInput" accept="image/*" style="display:none" />
    <h1 class="profile-name"><%= user.name %></h1>
  </div>
</div>

<div class="page-body">
  <div class="content-card">
    <form action="/profile/edit" method="POST">
      <div class="info-section">
        <h2 class="section-title">Personal Information</h2>

        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" name="name" class="form-input" value="<%= user.name %>" required>
        </div>

        <div class="info-cards">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-input" value="<%= user.email %>" required>
          </div>

          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="text" name="phone" class="form-input" value="<%= user.phone %>" required>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button type="submit" class="btn">Update Profile</button>
      </div>

      <% if (message) { %>
        <div class="message"><%= message %></div>
      <% } %>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const form = document.querySelector('form');
  const inputs = form.querySelectorAll('input');

  // Real-time validation
  inputs.forEach(input => {
    input.addEventListener('input', () => {
      validateField(input);
    });
  });

  function validateField(input) {
    const value = input.value.trim();
    let valid = true;
    let message = '';

    switch (input.name) {
      case 'name':
        if (value.length < 2) {
          valid = false;
          message = 'Name must be at least 2 characters';
        }
        break;
      case 'email':
        if (!/^\S+@\S+\.\S+$/.test(value)) {
          valid = false;
          message = 'Enter a valid email';
        }
        break;
      case 'phone':
        if (!/^\d{10}$/.test(value)) {
          valid = false;
          message = 'Phone must be 10 digits';
        }
        break;
      case 'line1':
        if (value && value.length < 5) {
          valid = false;
          message = 'Address must be at least 5 characters';
        }
        break;
      case 'landmark':
        if (value && value.length < 3) {
          valid = false;
          message = 'Landmark must be at least 3 characters';
        }
        break;
      case 'zip':
        if (value && !/^\d{5,6}$/.test(value)) {
          valid = false;
          message = 'ZIP must be 5 or 6 digits';
        }
        break;
    }

    if (valid) {
      input.classList.remove('error');
    } else {
      input.classList.add('error');
      if (message) showToast(message);
    }

    return valid;
  }

  function showToast(msg) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'error',
      title: msg,
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
  }

  form.addEventListener('submit', (e) => {
    let hasError = false;
    inputs.forEach(input => {
      if (!validateField(input)) hasError = true;
    });

    if (hasError) {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Invalid Input',
        text: 'Please fix the errors above',
        confirmButtonColor: '#4a5e4a'
      });
    }
  });

  // Profile Picture Upload
  const wrapper = document.getElementById('profileWrapper');
  const input = document.getElementById('profileImageInput');

  wrapper.addEventListener('click', () => input.click());

  input.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      return Swal.fire('Error', 'Please select an image file', 'error');
    }
    if (file.size > 5 * 1024 * 1024) {
      return Swal.fire('Error', 'Image must be under 5MB', 'error');
    }

    const fd = new FormData();
    fd.append('profileImage', file);

    try {
      const res = await fetch('/profile/upload-picture', { method: 'POST', body: fd });
      const data = await res.json();

      if (res.ok) {
        const img = document.getElementById('profileImg');
        if (img.tagName === 'DIV') {
          const newImg = document.createElement('img');
          newImg.src = data.profileImage + '?t=' + Date.now();
          newImg.className = 'profile-image-img';
          newImg.id = 'profileImg';
          newImg.alt = 'Profile';
          img.replaceWith(newImg);
        } else {
          img.src = data.profileImage + '?t=' + Date.now();
        }
        Swal.fire({ 
          icon: 'success', 
          title: 'Updated!', 
          text: 'Profile picture changed', 
          timer: 1500, 
          showConfirmButton: false,
          confirmButtonColor: '#4a5e4a'
        });
      } else {
        throw new Error(data.message || 'Upload failed');
      }
    } catch (err) {
      Swal.fire('Upload Failed', err.message, 'error');
    }
  });
</script>

<%- include('../partials/user/footer') %>