<%- include('../partials/user/header') %>

<style>
/* --------------------------------------------------------------
   1. ALL STYLES FROM profile.ejs (copy-paste the whole block)
   -------------------------------------------------------------- */
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#e8f4f3 0%,#d4e9e7 100%);min-height:100vh;padding:20px;}
.container {max-width:1200px;margin:0 auto;}

/* Profile Header (used as page title) */
.profile-container {background:linear-gradient(135deg,#1a7b7b 0%,#2d9c9c 100%);border-radius:20px 20px 0 0;padding:30px 40px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.1);}
.profile-container h2 {color:white;margin:0;font-size:28px;font-weight:600;}

/* Navigation Tabs – SAME AS PROFILE */
.nav-tabs {background:white;padding:20px 40px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap;border-bottom:2px solid #e8f4f3;box-shadow:0 2px 10px rgba(0,0,0,.05);}
.nav-tab {padding:12px 28px;background:transparent;color:#666;text-decoration:none;border-radius:25px;font-weight:600;font-size:15px;transition:all .3s;border:2px solid transparent;cursor:pointer;}
.nav-tab:hover {background:#e8f4f3;color:#1a7b7b;}
.nav-tab.active {background:#1a7b7b;color:white;border-color:#1a7b7b;}
.nav-tab.logout {background:#ff4757;color:white;}
.nav-tab.logout:hover {background:#ff3838;}

/* Content Card */
.content-card {background:white;border-radius:0 0 20px 20px;padding:40px;box-shadow:0 4px 20px rgba(0,0,0,.1);}

/* --------------------------------------------------------------
   2. YOUR ORIGINAL ORDER LIST STYLES (unchanged)
   -------------------------------------------------------------- */
.orders-container {max-width:1200px;margin:0 auto;padding:2rem 1rem;}
.page-header {margin-bottom:2rem;}
.page-title {font-size:2rem;font-weight:700;color:#111827;margin-bottom:.5rem;}
.page-subtitle {color:#6b7280;font-size:.95rem;}
.search-section {background:white;padding:1.5rem;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:1.5rem;}
.search-form {display:flex;gap:.75rem;align-items:center;}
.search-input {flex:1;max-width:400px;padding:.75rem 1rem;border:2px solid #e5e7eb;border-radius:8px;font-size:.95rem;transition:all .2s;}
.search-input:focus {outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1);}
.btn-search {padding:.75rem 1.5rem;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-search:hover {background:#2563eb;transform:translateY(-1px);}
.orders-grid {display:grid;gap:1.25rem;}
.order-card {background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:hidden;transition:all .3s;}
.order-card:hover {box-shadow:0 4px 12px rgba(0,0,0,.15);transform:translateY(-2px);}
.order-header {background:linear-gradient(135deg,#f9fafb 0%,#f3f4f6 100%);padding:1.25rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;}
.order-id {font-weight:700;font-size:1.1rem;color:#111827;}
.order-date {color:#6b7280;font-size:.9rem;display:flex;align-items:center;gap:.5rem;}
.order-body {padding:1.25rem;}
.order-info {display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem;}
.info-item {display:flex;flex-direction:column;gap:.25rem;}
.info-label {font-size:.8rem;color:#6b7280;text-transform:uppercase;font-weight:600;letter-spacing:.5px;}
.info-value {font-size:1.1rem;font-weight:600;color:#111827;}
.status-badge {padding:.4rem .9rem;border-radius:20px;font-size:.8rem;font-weight:600;text-transform:capitalize;display:inline-block;}
.status-pending{background:#fef3c7;color:#92400e;border:2px solid #fbbf24;}
.status-processing{background:#dbeafe;color:#1e40af;border:2px solid #3b82f6;}
.status-shipped{background:#dcfce7;color:#166534;border:2px solid #22c55e;}
.status-delivered{background:#d1fae5;color:#047857;border:2px solid #10b981;}
.status-cancelled{background:#fee2e2;color:#991b1b;border:2px solid #ef4444;}
.order-actions {display:flex;gap:.75rem;flex-wrap:wrap;padding-top:1rem;border-top:1px solid #f3f4f6;}
.action-btn {padding:.6rem 1.25rem;border-radius:8px;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s;text-decoration:none;border:none;display:inline-flex;align-items:center;gap:.5rem;}
.btn-view {background:#3b82f6;color:white;}
.btn-view:hover {background:#2563eb;transform:translateY(-1px);}
.btn-cancel {background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;}
.btn-cancel:hover {background:#fecaca;}
.btn-return {background:#fef3c7;color:#92400e;border:1px solid #fbbf24;}
.btn-return:hover {background:#fde68a;}
.btn-invoice {background:#d1fae5;color:#047857;border:1px solid #6ee7b7;}
.btn-invoice:hover {background:#a7f3d0;}
.pagination {margin-top:2rem;display:flex;justify-content:center;align-items:center;gap:.5rem;flex-wrap:wrap;}
.pagination a {padding:.6rem 1rem;border-radius:8px;text-decoration:none;font-weight:600;transition:all .2s;min-width:44px;text-align:center;}
.pagination a:not(.active){background:white;color:#374151;border:1px solid #e5e7eb;}
.pagination a:not(.active):hover{background:#f9fafb;border-color:#3b82f6;color:#3b82f6;}
.pagination a.active{background:#3b82f6;color:white;border:1px solid #3b82f6;}
.empty-state {text-align:center;padding:4rem 2rem;background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.empty-icon {font-size:4rem;color:#d1d5db;margin-bottom:1rem;}
.empty-title {font-size:1.5rem;font-weight:700;color:#374151;margin-bottom:.5rem;}
.empty-text {color:#6b7280;margin-bottom:1.5rem;}
.btn-shop {display:inline-block;padding:.75rem 2rem;background:#3b82f6;color:white;text-decoration:none;border-radius:8px;font-weight:600;transition:all .2s;}
.btn-shop:hover {background:#2563eb;transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,.3);}
.modal {position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000;padding:1rem;}
.modal.active {display:flex;}
.modal-content {background:white;padding:2rem;border-radius:16px;max-width:500px;width:100%;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);animation:modalSlideIn .3s ease-out;}
@keyframes modalSlideIn{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
.modal-title {font-size:1.5rem;font-weight:700;color:#111827;margin-bottom:1rem;}
.modal-text {color:#6b7280;margin-bottom:1.25rem;}
.modal-textarea {width:100%;padding:.75rem;border:2px solid #e5e7eb;border-radius:8px;font-size:.95rem;resize:vertical;min-height:100px;margin-bottom:1.25rem;transition:all .2s;}
.modal-textarea:focus {outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1);}
.modal-actions {display:flex;gap:.75rem;justify-content:flex-end;}
.modal-btn {padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;border:none;transition:all .2s;}
.modal-btn-primary {background:#ef4444;color:white;}
.modal-btn-primary:hover {background:#dc2626;transform:translateY(-1px);}
.modal-btn-secondary {background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;}
.modal-btn-secondary:hover {background:#e5e7eb;}

/* Responsive */
@media (max-width:768px){
  body{padding:10px;}
  .profile-container{padding:20px;}
  .nav-tabs{padding:15px 10px;gap:8px;}
  .nav-tab{padding:10px 20px;font-size:14px;}
  .content-card{padding:30px 20px;}
  .orders-container{padding:1rem .5rem;}
  .page-title{font-size:1.5rem;}
  .search-form{flex-direction:column;}
  .search-input{max-width:100%;}
  .btn-search{width:100%;}
  .order-header{flex-direction:column;align-items:flex-start;}
  .order-actions{flex-direction:column;}
  .action-btn{width:100%;justify-content:center;}
}
</style>

<div class="container">

  <!-- ==== PAGE TITLE ==== -->
  <div class="profile-container">
    <h2>Your Orders</h2>
  </div>

  <!-- ==== NAVIGATION BAR (same as Profile) ==== -->
  <div class="nav-tabs">
    <a href="/profile" class="nav-tab">My Info</a>
    <a href="/profile/address" class="nav-tab">Address</a>
    <a href="/orders" class="nav-tab active">Orders</a>
    <a href="/profile#wallet" class="nav-tab">My Wallet</a>
    <a href="/logout" class="nav-tab logout">Logout</a>
  </div>

  <!-- ==== ORDER LIST CONTENT (your original code) ==== -->
  <div class="content-card">
    <div class="page-header">
      <h1 class="page-title">Your Orders</h1>
      <p class="page-subtitle">Track and manage all your orders in one place</p>
    </div>

    <!-- Search -->
    <div class="search-section">
      <form class="search-form" method="GET">
        <input type="text" name="search" value="<%= search %>" placeholder="Search by Order ID..." class="search-input" />
        <button type="submit" class="btn-search">Search</button>
      </form>
    </div>

    <% if (orders.length > 0) { %>
      <div class="orders-grid">
        <% orders.forEach(order => { %>
          <div class="order-card">
              <div class="order-header">
              <div>
                <div class="order-id">#<%= order.orderId %></div>
                <div class="order-date">
                  <%= new Date(order.createdOn).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                </div>
              </div>
              <% 
                // Prefer a derived status from item-level states when all items share the same final state
                const rawStatus = (order.status || order.orderStatus || order.currentStatus || order.state || '').toString().trim().toLowerCase();
                const itemStatuses = (order.orderedItems || []).map(i => ((i.status||'').toString().trim().toLowerCase())).filter(Boolean);

                let derivedStatus = rawStatus || '';
                if (itemStatuses.length > 0) {
                  if (itemStatuses.every(s => s === 'returned')) derivedStatus = 'returned';
                  else if (itemStatuses.every(s => s === 'cancelled')) derivedStatus = 'cancelled';
                  else if (itemStatuses.every(s => s === 'return request' || s === 'returned')) derivedStatus = derivedStatus || 'return request';
                  else if (!derivedStatus) derivedStatus = itemStatuses.find(Boolean) || 'pending';
                }

                const statusClass = (derivedStatus || 'pending').replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
                const statusDisplay = (derivedStatus || 'pending').split(/\s+/).map(s => s ? (s.charAt(0).toUpperCase() + s.slice(1).toLowerCase()) : '').filter(Boolean).join(' ');
              %>
              <span class="status-badge status-<%= statusClass %>"><%= statusDisplay %></span>
            </div>
            
            <div class="order-body">
              <!-- Product Images -->
              <div class="order-items-images" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                <% order.orderedItems.forEach(item => { %>
                  <div style="position: relative; text-align: center;">
                    <img 
                      src="<%= item.productSnapshot?.image || '/assets/img/placeholder.png' %>" 
                      alt="<%= item.name %>" 
                      style="
                        width: 80px; 
                        height: 80px; 
                        object-fit: cover; 
                        border-radius: 8px; 
                        border: 2px solid #e5e7eb;
                        transition: transform 0.3s;
                      "
                      onmouseover="this.style.transform='scale(1.1)'"
                      onmouseout="this.style.transform='scale(1)'"
                    />
                    <small style="
                      display: block; 
                      margin-top: 0.5rem; 
                      color: #6b7280; 
                      font-size: 0.8rem;
                      word-break: break-word;
                      max-width: 100px;
                    "><%= item.name.substring(0, 20) %>...</small>
                    <small style="
                      display: block;
                      color: #3b82f6;
                      font-weight: 600;
                      font-size: 0.75rem;
                      margin-top: 0.25rem;
                    ">Qty: <%= item.quantity %></small>
                  </div>
                <% }) %>
              </div>

              <div class="order-info">
                <% 
                  const orderStatusLC = ((order.status||'').toString().trim().toLowerCase());
                  const subtotal = Number(order.subtotal || 0);
                  const totalTax = Number(order.tax || 0);
                  const totalDiscount = Number(order.discount || 0);

                  const refundedVal = (() => {
                    if (order.refunded != null && !isNaN(Number(order.refunded)) && Number(order.refunded) > 0) return Number(order.refunded);
                    return (order.orderedItems || []).reduce((a, it) => {
                      const st = ((it.status||'').toString().toLowerCase());
                      if (['cancelled','returned'].includes(st)) {
                        if (it.refundAmount != null && !isNaN(Number(it.refundAmount))) return a + Number(it.refundAmount);
                        const itemSubtotal = Number(it.totalPrice ?? (it.price * it.quantity) ?? 0);
                        const taxShare = subtotal > 0 ? (itemSubtotal / subtotal) * totalTax : 0;
                        const discountShare = subtotal > 0 ? (itemSubtotal / subtotal) * totalDiscount : 0;
                        return a + (itemSubtotal + taxShare - discountShare);
                      }
                      return a;
                    }, 0);
                  })();

                  const roundedRefunded = Math.round((refundedVal + Number.EPSILON) * 100) / 100;
                  const cappedRefunded = Math.min(roundedRefunded, Number(order.finalAmount || 0));
                  const finalPaid = Math.max(0, Math.round(((order.finalAmount || 0) - cappedRefunded + Number.EPSILON) * 100) / 100);
                  const hasItemRefund = cappedRefunded > 0;
                %>

                <div class="info-item">
                  <span class="info-label">Total Amount</span>
                  <span class="info-value">₹<%= order.finalAmount.toLocaleString() %></span>

                  <% if (orderStatusLC === 'cancelled' || orderStatusLC === 'returned') { %>
                    <small class="block text-green-600 font-medium">Full Refund Processed</small>
                  <% } else if (hasItemRefund) { %>
                    <small class="block text-green-600 font-medium">Partial Refund Processed</small>
                  <% } %>

                  <% if (hasItemRefund) { %>
                    <div style="margin-top:6px; color:#059669; font-weight:700;">
                      Refunded: ₹<%= cappedRefunded.toLocaleString() %>
                      &nbsp;&middot;&nbsp; Paid: ₹<%= finalPaid.toLocaleString() %>
                    </div>
                  <% } %>
                </div>
              </div>
              
              <div class="order-actions">
                <a href="/orders/<%= order._id %>" class="action-btn btn-view">
                  View Details
                </a>
                <% if (orderStatusLC === 'pending') { %>
                  <button onclick="cancelOrder('<%= order._id %>')" class="action-btn btn-cancel">
                    Cancel Order
                  </button>
                <% } %>
                <% 
                  // Hide order-level return button if all items are already returned/cancelled
                  const allReturnedOrCancelled = order.orderedItems && order.orderedItems.every(item => ['returned','cancelled'].includes(((item.status||'').toString().toLowerCase())));
                %>
                <% if (orderStatusLC === 'delivered' && !allReturnedOrCancelled) { %>
                  <button onclick="returnOrder('<%= order._id %>')" class="action-btn btn-return">
                    Return Order
                  </button>
                <% } %>
                <% 
    const orderHasDeliveredItem = order.orderedItems?.some(item => ['delivered','returned'].includes(((item.status||'').toString().toLowerCase())));
    const canShowInvoice = (orderStatusLC === 'delivered') || orderHasDeliveredItem;
%>

<% if (canShowInvoice) { %>
    <a href="/orders/<%= order._id %>/invoice" class="action-btn btn-invoice">
        Download Invoice
    </a>
<% } else { %>
    <!-- <span class="action-btn btn-invoice" style="background:#9ca3af; cursor:not-allowed; opacity:0.7;">
        Invoice After Delivery
    </span> -->
<% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <% if (currentPage > 1) { %>
          <a href="?page=<%= currentPage - 1 %>&search=<%= search %>">Previous</a>
        <% } %>
        <% for (let i = 1; i <= totalPages; i++) { %>
          <a href="?page=<%= i %>&search=<%= search %>" class="<%= i === currentPage ? 'active' : '' %>"><%= i %></a>
        <% } %>
        <% if (currentPage < totalPages) { %>
          <a href="?page=<%= currentPage + 1 %>&search=<%= search %>">Next</a>
        <% } %>
      </div>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-icon">Cart</div>
        <h3 class="empty-title">No orders found</h3>
        <p class="empty-text">You haven't placed any orders yet. Start shopping to see your orders here!</p>
        <a href="/shop" class="btn-shop">Start Shopping</a>
      </div>
    <% } %>
  </div>
</div>

<!-- Cancel Modal -->
<div id="cancelModal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">Cancel Order</h3>
    <p class="modal-text">Are you sure you want to cancel this order? This action cannot be undone.</p>
    <textarea id="cancelReason" placeholder="Please tell us why you're canceling (optional)" class="modal-textarea"></textarea>
    <div class="modal-actions">
      <button onclick="closeModal('cancelModal')" class="modal-btn modal-btn-secondary">Keep Order</button>
      <button onclick="confirmCancel()" class="modal-btn modal-btn-primary">Yes, Cancel Order</button>
    </div>
  </div>
</div>

<!-- Return Modal -->
<div id="returnModal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">Request Return</h3>
    <p class="modal-text">Please tell us why you want to return this order. This helps us improve our service.</p>
    <textarea id="returnReason" placeholder="Return reason (required)" class="modal-textarea" required></textarea>
    <div class="modal-actions">
      <button onclick="closeModal('returnModal')" class="modal-btn modal-btn-secondary">Cancel</button>
      <button onclick="confirmReturn()" class="modal-btn modal-btn-primary">Submit Return Request</button>
    </div>
  </div>
</div>

<script>
let currentOrderId = '';

function cancelOrder(id) {
  currentOrderId = id;
  document.getElementById('cancelModal').classList.add('active');
}

function returnOrder(id) {
  currentOrderId = id;
  document.getElementById('returnModal').classList.add('active');
}

function confirmCancel() {
  const reason = document.getElementById('cancelReason').value;
  fetch(`/orders/${currentOrderId}/cancel`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reason, isFullOrder: true })
  }).then(res => res.json()).then(data => {
    if (data.success) location.reload();
    else alert(data.message);
  });
}

function confirmReturn() {
  const reason = document.getElementById('returnReason').value;
  if (!reason) return alert('Reason required');
  fetch(`/orders/${currentOrderId}/return`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reason })
  }).then(res => res.json()).then(data => {
    if (data.success) location.reload();
    else alert(data.message);
  });
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

// Close modal when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', e => {
    if (e.target === modal) closeModal(modal.id);
  });
});

/* --------------------------------------------------------------
   Highlight "Orders" tab on any /orders page
   -------------------------------------------------------------- */
document.querySelectorAll('.nav-tab').forEach(tab => {
  if (tab.getAttribute('href') === '/orders') {
    tab.classList.add('active');
  } else {
    tab.classList.remove('active');
  }
});
</script>

<%- include('../partials/user/footer') %>