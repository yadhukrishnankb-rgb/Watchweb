<!-- views/admin/inventory.ejs -->
<%- include('../partials/admin/header') %>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<main class="p-6 bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-gray-900">Inventory Management</h1>
      <a href="/admin/products" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Product</a>
    </div>

    <!-- Search & Filter -->
    <form method="GET" class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap gap-3">
      <input name="search" value="<%= search %>" placeholder="Search product..." class="px-3 py-2 border rounded flex-1 min-w-64">
      <select name="stock" class="px-3 py-2 border rounded">
        <option value="">All Stock</option>
        <option value="low" <%= stockFilter === 'low' ? 'selected' : '' %>>Low Stock</option>
        <option value="out" <%= stockFilter === 'out' ? 'selected' : '' %>>Out of Stock</option>
      </select>
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
      <% if (hasSearch) { %>
        <a href="/admin/inventory" class="px-4 py-2 bg-gray-600 text-white rounded">Clear</a>
      <% } %>
    </form>

    <!-- Inventory Table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% products.forEach(p => { %>
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 flex items-center gap-3">
                <img src="<%= p.productImage[0] %>" alt="<%= p.productName %>" class="w-12 h-12 object-cover rounded">
                <div>
                  <p class="font-medium"><%= p.productName %></p>
                  <p class="text-xs text-gray-500">Threshold: <%= p.lowStockThreshold %></p>
                </div>
              </td>
              <td class="px-6 py-4">
                <input type="number" value="<%= p.quantity %>" min="0"
                       class="stock-input w-20 px-2 py-1 border rounded text-center"
                       data-id="<%= p._id %>">
              </td>
              <td class="px-6 py-4 status-cell" data-id="<%= p._id %>">
                <% if (p.quantity === 0) { %>
                  <span class="px-2 py-1 text-xs rounded bg-red-100 text-red-800">Out of Stock</span>
                <% } else if (p.quantity <= p.lowStockThreshold) { %>
                  <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">Low (<%= p.quantity %>)</span>
                <% } else { %>
                  <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">In Stock</span>
                <% } %>
              </td>
              <td class="px-6 py-4">
                <button class="save-stock text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                        data-id="<%= p._id %>">Save</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
      <div class="mt-6 flex justify-center gap-2">
        <% for(let i = 1; i <= totalPages; i++) { %>
          <a href="/admin/inventory?page=<%= i %>&search=<%= search %>&stock=<%= stockFilter %>"
             class="px-3 py-1 rounded <%= i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200' %>">
            <%= i %>
          </a>
        <% } %>
      </div>
    <% } %>
  </div>
</main>

<script>
$(document).on('click', '.save-stock', function() {
  const btn = $(this);
  const id = btn.data('id');
  const input = $(`input.stock-input[data-id="${id}"]`);
  const qty = parseInt(input.val());

  if (isNaN(qty) || qty < 0) {
    alert('Please enter a valid quantity');
    return;
  }

  $.ajax({
    url: `/admin/inventory/${id}/stock`,
    method: 'PATCH',
    data: { quantity: qty },
    success: function(res) {
      if (res.success) {
        input.val(res.quantity);
        const statusCell = $(`.status-cell[data-id="${id}"]`);
        let statusHtml = '';
        if (res.quantity === 0) {
          statusHtml = '<span class="px-2 py-1 text-xs rounded bg-red-100 text-red-800">Out of Stock</span>';
        } else if (res.quantity <= 5) {
          statusHtml = `<span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">Low (${res.quantity})</span>`;
        } else {
          statusHtml = '<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">In Stock</span>';
        }
        statusCell.html(statusHtml);
        alert('Stock updated successfully!');
      } else {
        alert(res.message || 'Update failed');
      }
    },
    error: function() {
      alert('Server error. Please try again.');
    }
  });
});
</script>

<%- include('../partials/admin/footer') %>